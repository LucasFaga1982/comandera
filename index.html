<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pizza Gourmet Longchamps ‚Äî Comandas</title>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#111827;       /* gray-900 */
      --card:#1f2937;        /* gray-800 */
      --muted:#94a3b8;       /* slate-400 */
      --text:#f8fafc;        /* slate-50 */
      --accent:#ef9963;      /* Naty palette */
      --accent-2:#4d3069;    /* Naty palette */
      --ok:#22c55e;          /* green-500 */
      --warn:#f59e0b;        /* amber-500 */
      --danger:#ef4444;      /* red-500 */
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    html,body{height:100%;}
    body{
      margin:0; background:linear-gradient(135deg,var(--bg),#060b25 60%);
      color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
      display:flex; flex-direction:column;
    }
    header{
      display:flex; align-items:center; gap:12px; justify-content:space-between;
      padding:16px 22px; background:transparent; position:sticky; top:0; backdrop-filter: blur(6px);
      z-index:30; border-bottom:1px solid rgba(255,255,255,.06);
    }
    .brand{display:flex; align-items:baseline; gap:10px}
    .brand h1{margin:0; font-size:20px; letter-spacing:.4px}
    .brand small{color:var(--muted)}
    .actions{display:flex; gap:10px; align-items:center}
    .btn{
      border:none; border-radius:14px; padding:10px 14px; cursor:pointer; font-weight:600; 
      background:var(--accent); color:#111; box-shadow:var(--shadow); transition:transform .05s ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.alt{background:var(--accent-2); color:#fff}
    .btn.ghost{background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.15)}

    .layout{display:grid; grid-template-columns: 1.2fr .8fr; gap:18px; padding:18px;}
    @media(max-width: 980px){ .layout{grid-template-columns:1fr;}}

    .panel{background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow)}

    /* Cat√°logo */
    .catalog{
      padding:18px; min-height:60vh; display:flex; flex-direction:column;
    }
    .toolbar{display:flex; gap:10px; align-items:center; margin-bottom:14px}
    .search{flex:1;}
    .search input{width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0b1028; color:var(--text)}
    .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(170px,1fr)); gap:12px}
    .card{
      background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px; cursor:pointer; position:relative; overflow:hidden;
      min-height:86px; display:flex; align-items:center; justify-content:center; text-align:center; font-weight:700; letter-spacing:.2px
    }
    .card:hover{outline:2px solid rgba(239,153,99,.45)}
    .badge{position:absolute; top:10px; right:10px; font-size:12px; color:var(--muted)}

    /* Comanda */
    .order{ padding:16px; display:flex; flex-direction:column; gap:12px }
    .order h3{margin:6px 0 0}
    .order-list{display:flex; flex-direction:column; gap:8px; max-height:60vh; overflow:auto; padding-right:4px}
    .item{display:grid; grid-template-columns:1fr auto auto auto; gap:10px; align-items:center; background:#0b1028; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px}
    .item .name{font-weight:700}
    .qtyctrl{display:flex; gap:6px; align-items:center}
    .qtyctrl button{background:#111a3a; color:#fff; border:1px solid rgba(255,255,255,.12); border-radius:9px; width:28px; height:28px; cursor:pointer}
    .remove{background:transparent; border:none; color:var(--danger); cursor:pointer; font-weight:700}
    .total{display:flex; justify-content:space-between; align-items:center; gap:12px; border-top:1px dashed rgba(255,255,255,.2); padding-top:12px; margin-top:6px}
    .total .sum{font-size:20px; font-weight:800}

    .print-hint{color:var(--muted); font-size:12px}

    /* Modal */
    .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.5); z-index:50}
    .modal.active{display:grid}
    .modal .box{background:#0b1028; border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:18px; min-width:320px; max-width:92vw}
    .box h4{margin:4px 0 12px}
    .row{display:flex; gap:8px; margin:10px 0}
    .row select, .row input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:#0a1436; color:var(--text)}

    /* Vistas */
    [data-view]{display:none}
    [data-view].active{display:block}

    /* Editor de precios */
    .editor{ padding:18px; }
    .list{ display:grid; gap:8px; }
    .row-edit{display:grid; grid-template-columns: 1fr 140px 120px 120px; gap:10px; align-items:center; background:#0b1028; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px}
    .row-edit input{width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:#081133; color:var(--text)}
    .row-edit .meta{color:var(--muted); font-size:12px}
    .editor-actions{display:flex; gap:10px; margin-top:12px}

    /* Impresi√≥n */
    @media print{
      body{background:#fff; color:#000}
      header, .catalog, .btn-edit, .print-hint{display:none !important}
      .order{background:#fff; border:none; box-shadow:none}
      .panel{border:none}
      .order-list .item{border:1px solid #000}
      .total{border-top:1px solid #000}
      [data-view="#pos"], [data-view="#precios"]{display:block}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <h1>Pizza Gourmet Longchamps</h1>
      <small>Comandas & Precios</small>
    </div>
    <div class="actions">
      <button class="btn ghost" id="reloadBtn" title="Recargar cat√°logo">‚Üª Recargar</button>
      <button class="btn btn-edit" id="toggleEditor">Editar precios</button>
    </div>
  </header>

  <main class="layout">
    <!-- Cat√°logo y cards -->
    <section class="panel catalog" data-view="#pos">
      <div class="toolbar">
        <div class="search"><input id="q" placeholder="Buscar producto‚Ä¶" /></div>
        <button class="btn alt" id="clearOrder">Vaciar pedido</button>
      </div>
      <div class="grid" id="cards"></div>
    </section>

    <!-- Comanda -->
    <aside class="panel order">
      <h3>Comanda</h3>
      <div class="order-list" id="orderList"></div>
      <div class="total">
        <div>
          <div class="print-hint">Imprime solo esta comanda</div>
          <strong>Total</strong>
        </div>
        <div class="sum" id="sumTotal">$0</div>
      </div>
      <div class="editor-actions">
        <button class="btn" id="printBtn">üñ®Ô∏è Imprimir</button>
      </div>
    </aside>

    <!-- Editor de Precios -->
    <section class="panel editor" data-view="#precios">
      <h3>Editor de precios</h3>
      <p class="print-hint">Modific√° precios en l√≠nea. Para agregar productos nuevos: <a id="dbLink" href="#" target="_blank">dirigite a la base de datos</a>.</p>
      <div class="list" id="priceList"></div>
      <div class="editor-actions">
        <button class="btn" id="savePrices">Guardar cambios</button>
        <button class="btn ghost" id="backPos">Volver a comandas</button>
      </div>
      <div id="saveStatus" class="print-hint"></div>
    </section>
  </main>

  <!-- Modal Selecci√≥n -->
  <div class="modal" id="modal">
    <div class="box">
      <h4 id="modalTitle">Agregar</h4>
      <div class="row">
        <select id="sizeSelect"></select>
        <input id="qtyInput" type="number" min="1" value="1" />
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn ghost" id="cancelModal">Cancelar</button>
        <button class="btn" id="confirmModal">Agregar</button>
      </div>
    </div>
  </div>

  <script>
    // ======= CONFIG =======
    const DB_URL = "https://script.google.com/macros/s/AKfycbzD7mn33jI9rPVzmo4n-ZhaKHIgvNvmFy90KjXrUn_o-jKSfdywUx8lBytFbxTAfvDk8A/exec"; // listado
    const DB_URL_EDIT = DB_URL;   // mismo endpoint para POST (deber√°s habilitar en Apps Script)

    // ======= ESTADO =======
    let rawRows = [];       // filas crudas: {categoria, producto, tamano, precio}
    let catalog = [];       // variantes con id compuesto
    let byProduct = new Map(); // nombre -> variantes
    let order = [];         // {id, producto, tamano, precio, qty}

    // ======= UTILS =======
    const peso = n => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n||0);
    const keyOf = (r)=> `${r.categoria}__${r.producto}__${r.tamano}`;
    const $(id)=>document.getElementById(id);
  </script>
  <script>
    // Fallback for the short helper (since HTML validators may complain)
    function $(id){ return document.getElementById(id); }

    // Parse CSV robusto (simple)
    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      const out=[];
      for(let i=1;i<lines.length;i++){
        const cells = lines[i].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s=>s.replace(/^"|"$/g,'').trim());
        out.push({categoria:cells[0]||'', producto:cells[1]||'', tamano:cells[2]||'', precio: Number(String(cells[3]||'0').replace(/[^0-9.,]/g,'').replace(',','.'))||0});
      }
      return out;
    }

    async function fetchMenu(){
      const res = await fetch(DB_URL, {cache:'no-store'});
      const ct = res.headers.get('content-type')||'';
      let rows=[];
      if(ct.includes('application/json')){
        const data = await res.json();
        // Admite formas: array de objetos o {data:[...]}
        const arr = Array.isArray(data)? data : (Array.isArray(data.data)? data.data : []);
        rows = arr.map(x=>({
          categoria: String(x.Categor√≠a || x.Categoria || x.categoria || x.cat || '').trim(),
          producto: String(x.Producto || x.producto || '').trim(),
          tamano:   String(x.Tama√±o || x.Tamano || x.tamano || x.size || '').trim(),
          precio:   Number(String(x.Precio || x.precio || '0').toString().replace(/[^0-9.,]/g,'').replace(',','.'))||0,
        }));
      } else { // CSV / texto
        const txt = await res.text();
        rows = parseCSV(txt);
      }
      // Filtrar v√°lidos
      rows = rows.filter(r=>r.producto);
      return rows;
    }

    function buildCatalog(rows){
      rawRows = rows;
      catalog = rows.map(r=>({ id:keyOf(r), ...r }));
      byProduct = new Map();
      for(const r of catalog){
        const k = r.producto;
        if(!byProduct.has(k)) byProduct.set(k, []);
        byProduct.get(k).push(r);
      }
      // ordenar variantes por tama√±o alfab√©tico y precio
      for(const arr of byProduct.values()) arr.sort((a,b)=> (a.tamano||'').localeCompare(b.tamano||'') || a.precio-b.precio);
    }

    function renderCards(filter=''){
      const wrap = $('cards');
      wrap.innerHTML='';
      const needle = filter.trim().toLowerCase();
      const products = [...byProduct.keys()].sort((a,b)=>a.localeCompare(b,'es'))
        .filter(name => !needle || name.toLowerCase().includes(needle));
      for(const name of products){
        const card = document.createElement('button');
        card.className = 'card';
        card.innerHTML = `<span>${name}</span>`;
        card.title = 'Agregar';
        card.addEventListener('click', ()=> openModalFor(name));
        wrap.appendChild(card);
      }
    }

    function openModalFor(productName){
      const variants = byProduct.get(productName)||[];
      $('modalTitle').textContent = productName;
      const sel = $('sizeSelect');
      sel.innerHTML='';
      for(const v of variants){
        const label = v.tamano ? `${v.tamano} ‚Äî ${peso(v.precio)}` : `${peso(v.precio)}`;
        const opt = document.createElement('option');
        opt.value = v.id; opt.textContent = label; sel.appendChild(opt);
      }
      $('qtyInput').value = 1;
      $('modal').classList.add('active');
    }

    function closeModal(){ $('modal').classList.remove('active'); }

    function addFromModal(){
      const id = $('sizeSelect').value;
      const qty = Math.max(1, parseInt($('qtyInput').value||'1',10));
      const variant = catalog.find(x=>x.id===id);
      if(!variant){ closeModal(); return; }
      const existing = order.find(x=>x.id===id);
      if(existing){ existing.qty += qty; } else {
        order.push({ id:variant.id, producto:variant.producto, tamano:variant.tamano, precio:variant.precio, qty });
      }
      renderOrder();
      closeModal();
    }

    function renderOrder(){
      const list = $('orderList');
      list.innerHTML='';
      let sum = 0;
      for(const it of order){
        const li = document.createElement('div');
        li.className='item';
        const name = document.createElement('div');
        name.className='name';
        name.innerHTML = `${it.producto}${it.tamano?` <span class="meta">(${it.tamano})</span>`:''}`;
        const price = document.createElement('div'); price.textContent=peso(it.precio);
        const qty = document.createElement('div'); qty.className='qtyctrl';
        const minus = document.createElement('button'); minus.textContent='‚àí'; minus.onclick=()=>{ it.qty=Math.max(0,it.qty-1); if(it.qty===0){ order=order.filter(o=>o!==it);} renderOrder(); };
        const span  = document.createElement('span'); span.textContent=it.qty; span.style.minWidth='18px'; span.style.textAlign='center';
        const plus  = document.createElement('button'); plus.textContent='+'; plus.onclick=()=>{ it.qty++; renderOrder(); };
        qty.append(minus,span,plus);
        const rm = document.createElement('button'); rm.className='remove'; rm.textContent='‚úï'; rm.onclick=()=>{ order=order.filter(o=>o!==it); renderOrder(); };
        li.append(name, price, qty, rm);
        list.appendChild(li);
        sum += it.precio * it.qty;
      }
      $('sumTotal').textContent = peso(sum);
      localStorage.setItem('pgl_order', JSON.stringify(order));
    }

    function restoreOrder(){
      try{ order = JSON.parse(localStorage.getItem('pgl_order')||'[]')||[]; }catch{ order=[] }
      renderOrder();
    }

    // ============ Editor de precios ============
    function showView(hash){
      const pos = document.querySelector('[data-view="#pos"]');
      const ed  = document.querySelector('[data-view="#precios"]');
      if(hash==="#precios"){ ed.classList.add('active'); pos.classList.remove('active'); }
      else { pos.classList.add('active'); ed.classList.remove('active'); }
    }

    function renderEditor(){
      const wrap = $('priceList');
      wrap.innerHTML='';
      // mostrar cada variante como fila editable
      for(const v of catalog){
        const row = document.createElement('div'); row.className='row-edit'; row.dataset.id=v.id;
        const title = document.createElement('div');
        title.innerHTML = `<strong>${v.producto}</strong> <span class="meta">${v.tamano?`(${v.tamano})`:''}</span>`;
        const cat = document.createElement('div'); cat.className='meta'; cat.textContent = v.categoria||'';
        const price = document.createElement('input'); price.type='number'; price.step='1'; price.min='0'; price.value = v.precio; price.dataset.orig=v.precio;
        const now  = document.createElement('div'); now.className='meta'; now.textContent = peso(v.precio);
        row.append(title, cat, price, now);
        wrap.appendChild(row);
      }
      $('dbLink').href = DB_URL; // abre base
    }

    async function saveEditor(){
      const rows = [...document.querySelectorAll('.row-edit')];
      const updates = [];
      for(const r of rows){
        const id = r.dataset.id; const priceInput = r.querySelector('input');
        const newPrice = Number(priceInput.value||0);
        const v = catalog.find(x=>x.id===id);
        if(v && newPrice !== v.precio){
          updates.push({ categoria:v.categoria, producto:v.producto, tamano:v.tamano, precio:newPrice });
        }
      }
      if(updates.length===0){ $('saveStatus').textContent='No hay cambios.'; return; }
      $('saveStatus').textContent='Guardando cambios‚Ä¶';
      try{
        // POST por lotes; tu Apps Script debe aceptar este payload
        const res = await fetch(DB_URL_EDIT, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action:'updatePrices', updates })
        });
        const ok = res.ok; const data = ok? await res.json().catch(()=>({success:true})) : null;
        if(ok && (!data || data.success!==false)){
          $('saveStatus').textContent = `Cambios guardados (${updates.length}). Recargando‚Ä¶`;
          await loadAll();
          renderEditor();
        } else {
          $('saveStatus').textContent = 'No se pudo guardar: revis√° el Apps Script del backend.';
        }
      }catch(err){
        console.error(err);
        $('saveStatus').textContent = 'Error de red o CORS. Ver consola.';
      }
    }

    // ======= BOOT =======
    async function loadAll(){
      const rows = await fetchMenu();
      buildCatalog(rows);
      renderCards($('q').value||'');
      renderOrder();
    }

    // Eventos UI
    window.addEventListener('hashchange', ()=> showView(location.hash||'#pos'));
    $('toggleEditor').addEventListener('click', ()=>{
      if(location.hash==="#precios") location.hash = '#pos'; else location.hash = '#precios';
    });
    $('backPos').addEventListener('click', ()=>{ location.hash='#pos'; });
    $('reloadBtn').addEventListener('click', loadAll);
    $('q').addEventListener('input', (e)=> renderCards(e.target.value));
    $('clearOrder').addEventListener('click', ()=>{ order=[]; renderOrder(); });
    $('printBtn').addEventListener('click', ()=>{ window.print(); });

    $('cancelModal').addEventListener('click', closeModal);
    $('confirmModal').addEventListener('click', addFromModal);

    // Inicio
    showView(location.hash||'#pos');
    restoreOrder();
    loadAll().catch(err=>{ console.error(err); alert('No se pudo cargar la base. Ver consola.'); });
  </script>
</body>
</html>
