<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Comandas - Pizzería Gourmet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Roboto', sans-serif; }
        h1, h2, h3 { font-family: 'Roboto Slab', serif; }
        .btn-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* Estilos para la impresión del ticket */
        @media print {
            body * { visibility: hidden; }
            #ticket-imprimible, #ticket-imprimible * { visibility: visible; }
            #ticket-imprimible {
                position: absolute; left: 0; top: 0; width: 100%;
                font-family: 'Courier New', Courier, monospace;
                font-size: 10px; color: #000;
            }
            #ticket-imprimible h1 { font-size: 14px; font-weight: bold; text-align: center; margin-bottom: 5px; }
            #ticket-imprimible p { margin-bottom: 3px; }
            #ticket-imprimible .item-line, #ticket-imprimible .total-line { display: flex; justify-content: space-between; }
            #ticket-imprimible .total-line { border-top: 1px dashed #000; padding-top: 3px; margin-top: 5px; font-weight: bold; }
        }
        /* Estilos del Modal */
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <main id="vista-pedidos" class="p-4 md:p-6">
        <header class="flex flex-wrap justify-between items-center mb-6 pb-4 border-b border-slate-300">
            <h1 class="text-4xl font-bold text-slate-900">Pizzería "Gourmet"</h1>
            <button id="btn-ir-a-precios" class="bg-slate-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-800 transition-all duration-300 shadow-md flex items-center gap-2 mt-4 sm:mt-0">
                <i class="fas fa-cog"></i>
                <span>Actualizar Precios</span>
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="lista-productos" class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-3xl font-semibold mb-5">Menú</h2>
                <div id="categorias-container" class="space-y-8">
                    <div class="text-center p-8">
                        <i class="fas fa-spinner fa-spin text-5xl text-red-700"></i>
                        <p class="mt-3 text-slate-600">Cargando productos...</p>
                    </div>
                </div>
            </div>

            <aside class="bg-slate-800 text-white p-6 rounded-xl shadow-lg flex flex-col">
                <h2 class="text-3xl font-semibold mb-4">Comanda Actual</h2>
                <div id="comanda-items" class="flex-grow min-h-[300px] border-b border-slate-600 pb-4 mb-4 overflow-y-auto">
                    <p id="comanda-vacia" class="text-slate-400 text-center mt-12">Agrega productos del menú para iniciar una comanda.</p>
                </div>
                <div class="space-y-4">
                    <div class="flex justify-between items-center text-2xl font-bold">
                        <span>TOTAL:</span>
                        <span id="comanda-total">$0.00</span>
                    </div>
                    <button id="btn-imprimir" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-700 transition-all duration-300 shadow-md flex items-center justify-center gap-2 disabled:bg-slate-500 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-print"></i>
                        <span>Imprimir Comanda</span>
                    </button>
                    <button id="btn-limpiar" class="w-full bg-rose-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-rose-700 transition-all duration-300 shadow-md">
                        <span>Limpiar Comanda</span>
                    </button>
                </div>
            </aside>
        </div>
    </main>

    <section id="vista-precios" class="p-4 md:p-6 hidden">
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-slate-300">
            <h1 class="text-4xl font-bold text-slate-900">Editar Precios y Productos</h1>
            <button id="btn-volver-a-pedidos" class="bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 transition-all duration-300 shadow-md flex items-center gap-2">
                <i class="fas fa-arrow-left"></i>
                <span>Volver</span>
            </button>
        </header>
        <div class="bg-white p-6 rounded-xl shadow-lg max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200">
                <h2 class="text-2xl font-semibold">Productos Existentes</h2>
                <button id="btn-abrir-modal-nuevo-producto" class="bg-red-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-800 transition-all duration-300 shadow-md flex items-center gap-2">
                    <i class="fas fa-plus"></i>
                    <span>Añadir Producto</span>
                </button>
            </div>
            
            <div id="lista-precios-container" class="space-y-4 max-h-[50vh] overflow-y-auto pr-2"></div>

            <div id="feedback-precios" class="mt-4 text-center"></div>
            <div class="mt-6 text-right">
                <button id="btn-guardar-precios" class="bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-emerald-700 transition-all duration-300 shadow-md flex items-center justify-center gap-2 disabled:bg-slate-500 disabled:cursor-not-allowed">
                    <i id="save-icon" class="fas fa-save"></i>
                    <span id="save-text">Guardar Cambios</span>
                </button>
            </div>
        </div>
    </section>
    
    <div id="ticket-imprimible" class="hidden"></div>

    <div id="modal-nuevo-producto" class="modal fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-4 border-b pb-2">Nuevo Producto</h3>
            <form id="form-nuevo-producto" class="space-y-4">
                <div>
                    <label for="nueva-categoria" class="block text-sm font-medium text-slate-700">Categoría</label>
                    <input type="text" id="nueva-categoria" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md focus:ring-red-500 focus:border-red-500" placeholder="Ej: Pizza Clásica">
                </div>
                <div>
                    <label for="nuevo-producto" class="block text-sm font-medium text-slate-700">Nombre del Producto</label>
                    <input type="text" id="nuevo-producto" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md focus:ring-red-500 focus:border-red-500" placeholder="Ej: Muzzarella Especial">
                </div>
                <div>
                    <label for="nuevo-tamano" class="block text-sm font-medium text-slate-700">Tamaño/Variante</label>
                    <input type="text" id="nuevo-tamano" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md focus:ring-red-500 focus:border-red-500" placeholder="Ej: Grande o Litro">
                </div>
                <div>
                    <label for="nuevo-precio" class="block text-sm font-medium text-slate-700">Precio ($)</label>
                    <input type="number" step="0.01" id="nuevo-precio" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md focus:ring-red-500 focus:border-red-500" placeholder="Ej: 15.50">
                </div>
                <div id="feedback-nuevo-producto" class="text-center"></div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="btn-cerrar-modal" class="bg-slate-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-600 transition-all duration-300">Cancelar</button>
                    <button type="submit" id="btn-guardar-nuevo-producto" class="bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-700 transition-all duration-300 flex items-center gap-2">
                        <i id="new-product-icon" class="fas fa-plus-circle"></i>
                        <span id="new-product-text">Agregar</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURACIÓN ---
            // URL de publicación CSV de la hoja de cálculo (solo lectura)
            const URL_SHEET = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQpTRK2Hf7YmhcCExgsz0-GNJjeLXN3LCPw2J3z0Tp5t_WQyny9vh4T5QWM6W9diJntg5yD3THw-LqP/pub?output=csv';
            // URL del Google Apps Script (para POST/escritura)
            const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyk437BQbqBB5RrqgLQmPkDEEEES-aETvU3Scc6EaC8l9keeEdfU9aj2rJXAD5MRv5FVQ/exec';

            // Estado de la aplicación
            let productos = [];
            let comanda = [];

            // Alias para elementos del DOM
            const a = id => document.getElementById(id);
            const vistaPedidos = a('vista-pedidos'), vistaPrecios = a('vista-precios');
            const categoriasContainer = a('categorias-container'), comandaItemsContainer = a('comanda-items');
            const comandaTotalEl = a('comanda-total'), comandaVaciaEl = a('comanda-vacia');
            const listaPreciosContainer = a('lista-precios-container'), btnImprimir = a('btn-imprimir');
            const btnLimpiar = a('btn-limpiar'), ticketImprimibleContainer = a('ticket-imprimible');
            const btnGuardarPrecios = a('btn-guardar-precios');
            // Elementos del Nuevo Producto
            const modalNuevoProducto = a('modal-nuevo-producto');
            const btnAbrirModal = a('btn-abrir-modal-nuevo-producto');
            const btnCerrarModal = a('btn-cerrar-modal');
            const formNuevoProducto = a('form-nuevo-producto');
            const feedbackNuevoProducto = a('feedback-nuevo-producto');
            const btnGuardarNuevoProducto = a('btn-guardar-nuevo-producto');
            const newProductIcon = a('new-product-icon');
            const newProductText = a('new-product-text');


            // --- NAVEGACIÓN ---
            a('btn-ir-a-precios').addEventListener('click', () => cambiarVista('precios'));
            a('btn-volver-a-pedidos').addEventListener('click', () => cambiarVista('pedidos'));

            function cambiarVista(vista) {
                if (vista === 'precios') {
                    vistaPedidos.classList.add('hidden');
                    vistaPrecios.classList.remove('hidden');
                    renderizarEditorDePrecios();
                } else {
                    vistaPrecios.classList.add('hidden');
                    vistaPedidos.classList.remove('hidden');
                    // Al volver a pedidos, forzamos la recarga de datos
                    iniciarApp(); 
                }
            }

            // --- LÓGICA DE DATOS Y PARSEO CSV (Reforzado) ---
            async function cargarProductos() {
                try {
                    // Se agrega un parámetro a la URL para evitar problemas de caché
                    const response = await fetch(`${URL_SHEET}&t=${new Date().getTime()}`);
                    if (!response.ok) throw new Error('Error al cargar datos desde Google Sheets.');
                    const csvText = await response.text();
                    productos = parseCSV(csvText);
                    renderizarProductos();
                } catch (error) {
                    console.error('Error:', error);
                    categoriasContainer.innerHTML = `<p class="text-red-600 text-center font-semibold">No se pudieron cargar los productos. Revisa la URL o tu conexión.</p>`;
                }
            }
            
            // Función reforzada para parsear CSV y limpiar datos
            function parseCSV(text) {
                return text.split('\n').slice(1).map(linea => {
                    // Usamos la división simple por coma
                    const cols = linea.split(',');
                    
                    if (cols.length < 4) return null;
                    
                    // Limpieza exhaustiva de cada columna (quita comillas, \r, $ y espacios extra)
                    const [cat, prod, tam, precio] = cols.map(c => 
                        c.replace(/"/g, '').replace(/[\r$]/g, '').trim()
                    );
                    
                    // Conversión a número
                    const precioLimpio = precio ? parseFloat(precio) : 0;
                    
                    if (!prod || !tam) return null; // Ignorar filas sin producto/tamaño

                    return {
                        id: `${prod} - ${tam}`,
                        categoria: cat, producto: prod, tamano: tam,
                        precio: precioLimpio
                    };
                }).filter(p => p); // Filtra los nulos
            }
            
            // --- RENDERIZADO DE VISTAS ---
            function renderizarProductos() {
                const porCategoria = productos.reduce((acc, p) => {
                    (acc[p.categoria] = acc[p.categoria] || []).push(p);
                    return acc;
                }, {});
                
                // Limpiamos el container y lo llenamos con productos
                categoriasContainer.innerHTML = Object.keys(porCategoria).map(categoria => `
                    <div>
                        <h3 class="text-2xl font-bold border-b-2 border-red-700 pb-2 mb-4 text-slate-800">${categoria}</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            ${porCategoria[categoria].map(p => `
                                <button class="bg-slate-200 p-3 rounded-lg text-center hover:bg-red-700 hover:text-white transition-all duration-300 shadow focus:outline-none focus:ring-2 focus:ring-red-500 flex flex-col justify-between group"
                                        onclick="agregarAComanda('${p.id.replace(/'/g, "\\'")}')">
                                    <div>
                                        <p class="font-semibold">${p.producto}</p>
                                        <p class="text-xs text-slate-600 group-hover:text-red-100">${p.tamano}</p>
                                    </div>
                                    <p class="font-bold text-lg mt-2">$${p.precio.toFixed(2)}</p>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }

            function renderizarComanda() {
                comandaVaciaEl.classList.toggle('hidden', comanda.length > 0);
                btnImprimir.disabled = comanda.length === 0;
                
                const itemsHtml = comanda.length === 0 ? '' : comanda.map((item, index) => `
                    <div class="flex justify-between items-center py-2 border-b border-slate-600 animate-fade-in">
                        <div>
                            <p class="font-semibold text-white">${item.producto} <span class="font-normal text-slate-300 text-sm">(${item.tamano})</span></p>
                            <p class="text-sm text-slate-300">
                                <button class="px-2 rounded-full bg-slate-500 hover:bg-slate-400" onclick="actualizarCantidad(${index}, -1)">-</button>
                                <span class="mx-2 font-bold">${item.cantidad}</span>
                                <button class="px-2 rounded-full bg-slate-500 hover:bg-slate-400" onclick="actualizarCantidad(${index}, 1)">+</button>
                                x $${item.precio.toFixed(2)}
                            </p>
                        </div>
                        <p class="font-bold text-lg">$${(item.cantidad * item.precio).toFixed(2)}</p>
                    </div>
                `).join('');
                
                comandaItemsContainer.innerHTML = itemsHtml || comandaVaciaEl.outerHTML;
                
                const total = comanda.reduce((acc, item) => acc + (item.cantidad * item.precio), 0);
                comandaTotalEl.textContent = `$${total.toFixed(2)}`;
            }
            
            function renderizarEditorDePrecios() {
                listaPreciosContainer.innerHTML = productos.sort((a,b) => a.id.localeCompare(b.id)).map(p => `
                    <div class="grid grid-cols-3 items-center gap-4 py-2 border-b">
                        <span class="col-span-2 font-medium">${p.id}</span>
                        <div class="flex items-center">
                            <span class="mr-2 text-slate-500">$</span>
                            <input type="number" step="0.01" value="${p.precio.toFixed(2)}" data-producto-id="${p.id}" data-precio-original="${p.precio}"
                                    class="w-full p-2 border rounded-md focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        </div>
                    </div>
                `).join('');
            }
            
            // --- MANEJO DE LA COMANDA ---
            window.agregarAComanda = id => {
                const producto = productos.find(p => p.id === id);
                if (!producto) return;
                const itemExistente = comanda.find(item => item.id === id);
                if (itemExistente) itemExistente.cantidad++;
                else comanda.push({ ...producto, cantidad: 1 });
                renderizarComanda();
            };

            window.actualizarCantidad = (index, cambio) => {
                comanda[index].cantidad += cambio;
                if (comanda[index].cantidad <= 0) comanda.splice(index, 1);
                renderizarComanda();
            };
            
            btnLimpiar.addEventListener('click', () => {
                if (confirm('¿Estás seguro de que quieres limpiar la comanda actual?')) {
                    comanda = [];
                    renderizarComanda();
                }
            });

            // --- LÓGICA DE AGREGAR PRODUCTO NUEVO (Modal) ---
            btnAbrirModal.addEventListener('click', () => {
                modalNuevoProducto.classList.remove('hidden');
                feedbackNuevoProducto.innerHTML = '';
                formNuevoProducto.reset(); // Limpiar el formulario
            });

            btnCerrarModal.addEventListener('click', () => {
                modalNuevoProducto.classList.add('hidden');
            });

            formNuevoProducto.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Recolectar datos
                const nuevoProductoData = {
                    categoria: a('nueva-categoria').value.trim(),
                    producto: a('nuevo-producto').value.trim(),
                    tamano: a('nuevo-tamano').value.trim(),
                    precio: parseFloat(a('nuevo-precio').value)
                };

                // Simple validación
                if (!nuevoProductoData.categoria || !nuevoProductoData.producto || !nuevoProductoData.tamano || isNaN(nuevoProductoData.precio) || nuevoProductoData.precio <= 0) {
                    feedbackNuevoProducto.innerHTML = `<p class="text-red-600">Por favor, completa todos los campos correctamente.</p>`;
                    return;
                }

                btnGuardarNuevoProducto.disabled = true;
                newProductText.textContent = 'Agregando...';
                newProductIcon.className = 'fas fa-spinner btn-spinner';
                feedbackNuevoProducto.innerHTML = `<p class="text-slate-600">Enviando producto...</p>`;
                
                // **USO DE URLSearchParams para Apps Script**
                const payload = new URLSearchParams({
                    action: 'agregar', 
                    categoria: nuevoProductoData.categoria,
                    producto: nuevoProductoData.producto,
                    tamano: nuevoProductoData.tamano,
                    precio: nuevoProductoData.precio
                });

                try {
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: payload 
                    });
                    
                    const result = await response.json();
                    
                    if (result.code >= 200 && result.code < 300) { // 201 Created
                         feedbackNuevoProducto.innerHTML = `<p class="text-green-600 font-bold">${result.message} Volviendo a pedidos...</p>`;
                         setTimeout(() => {
                             modalNuevoProducto.classList.add('hidden');
                             cambiarVista('pedidos'); // Recarga la lista
                         }, 2500); 
                    } else {
                        throw new Error(result.message || 'Error desconocido del servidor');
                    }

                } catch (error) {
                    console.error('Error al agregar producto:', error);
                    feedbackNuevoProducto.innerHTML = `<p class="text-red-600 font-bold">Error: ${error.message || 'Hubo un error al guardar.'}</p>`;
                    btnGuardarNuevoProducto.disabled = false;
                    newProductText.textContent = 'Agregar';
                    newProductIcon.className = 'fas fa-plus-circle';
                }
            });

            // --- GUARDADO DE PRECIOS Y COMUNICACIÓN CON APPS SCRIPT ---
            btnGuardarPrecios.addEventListener('click', async () => {
                const inputs = listaPreciosContainer.querySelectorAll('input[data-producto-id]');
                const feedbackEl = a('feedback-precios');
                const saveIcon = a('save-icon');
                const saveText = a('save-text');

                const actualizaciones = Array.from(inputs).map(input => ({
                    id: input.dataset.productoId,
                    precio: parseFloat(input.value),
                    precioOriginal: parseFloat(input.dataset.precioOriginal)
                })).filter(p => p.precio.toFixed(2) !== p.precioOriginal.toFixed(2));

                if (actualizaciones.length === 0) {
                    feedbackEl.innerHTML = `<p class="text-blue-600">No hay cambios para guardar.</p>`;
                    return;
                }

                btnGuardarPrecios.disabled = true;
                saveText.textContent = 'Guardando...';
                saveIcon.className = 'fas fa-spinner btn-spinner';
                feedbackEl.innerHTML = `<p class="text-slate-600">Actualizando ${actualizaciones.length} producto(s)...</p>`;
                
                // Enviamos cada actualización por separado (con URLSearchParams)
                const promesas = actualizaciones.map(p => 
                    fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: new URLSearchParams({ 
                            action: 'actualizar', 
                            id: p.id, 
                            precio: p.precio 
                        })
                    }).then(res => res.json()) // Esperamos una respuesta JSON
                );

                try {
                    await Promise.all(promesas);
                    feedbackEl.innerHTML = `<p class="text-green-600 font-bold">¡Precios actualizados con éxito! Volviendo a la vista de pedidos.</p>`;
                    setTimeout(() => cambiarVista('pedidos'), 2500); 
                } catch (error) {
                    console.error('Error al actualizar:', error);
                    feedbackEl.innerHTML = `<p class="text-red-600 font-bold">Hubo un error al guardar. Revisa la consola para más detalles.</p>`;
                    btnGuardarPrecios.disabled = false;
                    saveText.textContent = 'Guardar Cambios';
                    saveIcon.className = 'fas fa-save';
                }
            });

            // --- IMPRESIÓN ---
            btnImprimir.addEventListener('click', () => {
                if (comanda.length === 0) return;
                const ahora = new Date();
                const fecha = ahora.toLocaleDateString('es-AR');
                const hora = ahora.toLocaleTimeString('es-AR', { hour: '2-digit', minute:'2-digit' });
                const total = comanda.reduce((acc, item) => acc + (item.cantidad * item.precio), 0);
                
                ticketImprimibleContainer.innerHTML = `
                    <h1>Pizzería "Gourmet"</h1>
                    <p>Fecha: ${fecha} - Hora: ${hora}</p>
                    <p>---------------------------------</p>
                    ${comanda.map(item => `
                        <div class="item-line">
                            <span>${item.cantidad}x ${item.producto} ${item.tamano}</span>
                            <span>$${(item.cantidad * item.precio).toFixed(2)}</span>
                        </div>
                    `).join('')}
                    <div class="total-line">
                        <span>TOTAL:</span>
                        <span>$${total.toFixed(2)}</span>
                    </div>
                    <p style="text-align:center; margin-top: 10px;">¡Gracias por su compra!</p>
                `;
                window.print();
            });

            // --- INICIO DE LA APP ---
            function iniciarApp() {
                cargarProductos();
                renderizarComanda();
            }

            iniciarApp();
        });
    </script>
</body>
</html>
