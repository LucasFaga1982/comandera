<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Comandas ¬∑ Pizza Gourmet Longchamps</title>
<style>
  :root{ --bg:#0d0f14; --panel:#111317; --card:#f5f6f7; --ink:#0b0d10;
         --brand:#00a86b; --muted:#9aa1aa; --shadow:0 12px 28px rgba(0,0,0,.35); --radius:18px; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; min-width:1100px;
    background:radial-gradient(1200px 1200px at 20% 10%, #151922 0%, #0d0f14 45%, #0a0c10 100%);
    color:#eef1f4;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif
  }

  /* Topbar */
  .topbar{position:sticky;top:0;z-index:50;display:flex;align-items:center;justify-content:space-between;gap:12px;
          padding:10px 14px;background:#0b0e13e6;border-bottom:1px solid #1d232f;backdrop-filter: blur(6px)}
  .brand{display:flex;align-items:center;gap:12px;cursor:pointer}
  .brand img{width:44px;height:44px;border-radius:999px;background:#fff;object-fit:cover;box-shadow:var(--shadow)}
  .brand .title{font-weight:800;letter-spacing:.3px}
  .brand .subtitle{font-size:12px;color:#c9ced6}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid #253042;background:#151a23;color:#eaf0f6;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;box-shadow:var(--shadow)}
  .btn:hover{border-color:#334359}
  .btn-brand{background:linear-gradient(135deg,var(--brand),#0e7f56);border:none;color:#fff}
  .btn-danger{background:#742323;border:1px solid #9f2a2a;color:#ffd9d9}
  .btn-ghost{background:transparent;border:1px dashed #374151}

  /* Subnav (Resumen/D√≠as) */
  .subnav{display:flex;gap:8px;margin:8px 16px 0}
  .chip{border:1px solid #22304a;background:#0e131c;color:#e9eef4;padding:8px 10px;border-radius:999px;cursor:pointer}
  .chip.active{border-color:var(--brand);color:#fff}

  /* Vistas: ocultar todo salvo la activa */
  .view{display:none !important}
  .view.active{display:grid !important}

  /* Layout general */
  .wrap{display:grid;grid-template-columns:3fr 1.15fr;gap:18px;max-width:1400px;margin:16px auto;padding:16px}
  .left{min-height:70vh;background:var(--panel);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
  .right{align-self:start;background:var(--panel);border-radius:var(--radius);
         padding:18px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:12px;max-height:calc(100vh - 100px)}

  /* üëâ Vista PEDIDOS: layout 70% productos | 30% comanda */
  #viewPedidos.wrap{grid-template-columns:70% 30%}
  #viewPedidos{position:relative}
  #viewPedidos .left{margin-right:0}
  #viewPedidos .right{position:sticky; top:76px; right:auto; width:auto; max-height:calc(100vh - 100px); overflow:auto}

  /* Contenido del panel derecho */
  .order-title{font-weight:900;font-size:20px;letter-spacing:.6px}
  .order-id{font-size:12px;color:#b7bfca}
  .order-list{display:flex;flex-direction:column;gap:10px;overflow:auto;padding-right:2px}
  .line{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;background:#0b1018;border:1px solid #213045;border-radius:12px;padding:10px 12px}
  .line h4{margin:0;font-size:14px}
  .line .muted{color:#93a0b2;font-size:12px}
  .qty{display:flex;align-items:center;gap:6px;background:#0a0f17;border:1px solid #253144;border-radius:10px;padding:4px 6px}
  .qty button{background:transparent;color:#e9eef4;border:none;font-size:16px;cursor:pointer}
  .price{min-width:88px;text-align:right;font-variant-numeric:tabular-nums;font-weight:800}
  .remove{background:transparent;border:none;color:#f3a3a3;cursor:pointer;margin-left:6px}
  .totals{margin-top:6px;border-top:1px dashed #344055;padding-top:10px;display:flex;justify-content:space-between;align-items:center}
  .total{font-size:18px;font-weight:900;color:#00d285}
  .small{font-size:12px;color:#b7bfca}
  .field{display:flex;flex-direction:column;gap:6px}
  .in{background:#0e131c;border:1px solid #22304a;color:#e9eef4;padding:8px 10px;border-radius:10px;outline:none}

  /* Tarjetas productos */
  .toolbar{display:flex;align-items:center;gap:10px;margin-bottom:12px}
  .search{flex:1;background:#0e131c;border:1px solid #22304a;color:#e9eef4;padding:10px 12px;border-radius:12px;outline:none}
  .badge{font-size:12px;color:#b8bfca}
  .category{margin:12px 0 18px;border:1px solid #1f2838;border-radius:16px;background:#0e1219}
  .cat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #1f2838;background:linear-gradient(180deg,#0f141e,#0e1219);border-top-left-radius:16px;border-top-right-radius:16px}
  .cat-name{font-weight:800;letter-spacing:.3px}
  .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;padding:12px}
  .card{background:var(--card);color:var(--ink);border:2px solid #e2e5e9;border-radius:18px;padding:18px;cursor:pointer;min-height:84px;
        display:flex;align-items:center;justify-content:center;text-align:center;font-weight:900;letter-spacing:.2px;text-transform:uppercase;
        box-shadow:0 6px 14px rgba(0,0,0,.15);transition:transform .08s ease, box-shadow .15s ease, border-color .15s ease}
  .card:hover{transform:translateY(-2px);border-color:var(--brand);box-shadow:0 10px 24px rgba(0,0,0,.25)}
  .card:focus-visible{outline:3px solid var(--brand);outline-offset:2px}

  /* Modal tama√±os */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:60;padding:16px}
  .modal.open{display:flex}
  .modal-card{width:min(560px,96vw);background:#0f141d;border:1px solid #233149;border-radius:18px;padding:18px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:12px}
  .modal .title{font-size:18px;font-weight:900}
  .size-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .size-btn{border:2px solid #2a3a52;background:#0b1018;color:#e9eef4;padding:12px;border-radius:12px;cursor:pointer;text-align:center;font-weight:800}
  .size-btn strong{display:block;color:#00a86b;font-size:13px;margin-top:4px}
  .size-btn:hover{border-color:#00a86b}
  .qty-row{display:flex;align-items:center;gap:10px;margin-top:4px}
  .qty-box{display:flex;align-items:center;gap:6px;background:#0a0f17;border:1px solid #253144;border-radius:10px;padding:6px 8px}
  .qty-box input{width:64px;background:transparent;border:none;color:#e9eef4;font-weight:700;text-align:center;outline:none}
  .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:4px}

  /* Tabla */
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #22304a;padding:8px;text-align:left;font-size:14px}
  th{color:#cfd6df}
  tr:hover td{background:#0e131c}

  /* Print */
  @media print{
    body{background:#fff}
    .topbar,.left,.btn,.toolbar,.subnav{display:none !important}
    /* Imprimimos SOLO el panel derecho activo */
    .right{position:static !important;box-shadow:none;border:none;padding:0;margin:0;width:100%}
    .ticket{width:72mm;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;color:#000;background:#fff}
    .ticket h2{margin:0 0 6px}
    .line{border:none;background:#fff;padding:4px 0}
    .remove,.qty{display:none}
    .totals{border-top:1px solid #000}
  }
</style>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ecf2ef">

  <!-- Iconos -->
  <link rel="icon" href="logo-192.png" sizes="192x192">
  <link rel="icon" href="logo-512.png" sizes="512x512">
  <link rel="apple-touch-icon" href="logo-192.png">

  <!-- (Opcional iOS) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Excel export (SheetJS) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Brand Light Theme (forced) -->
  <style id="brand-light-theme">
    :root{
      /* extracted from brand image */
      --bg: #fbfaf8;           /* off-white / crema */
      --bg-soft:#ffffff;
      --panel:#ffffff;
      --panel-alt:#fbfaf8;
      --text:#0e0f0b;          /* casi negro */
      --muted:#60675c;         /* gris medio verdoso */
      --primary:#2c4735;       /* verde oscuro (marca) */
      --primary-contrast:#ffffff;
      --accent:#bbc5bd;        /* verde salvia claro */
      --accent-contrast:#0e0f0b;
      --border:#e6e6e2;
      --success:#2c4735;
      --danger:#c62828;
      --warning:#b78129;
      --input-bg:#ffffff;
    }
    html, body{ background: var(--bg); color: var(--text); }
    /* neutralizar cualquier modo oscuro previo */
    @media (prefers-color-scheme: dark){
      html, body{ background: var(--bg) !important; color: var(--text) !important; }
    }
    /* contenedores */
    .topbar, .wrap, main.view, section, aside, .card, .panel, .modal, .drawer{
      background: var(--panel);
      color: var(--text);
    }
    .topbar{ border-bottom:1px solid var(--border); box-shadow:0 1px 6px rgba(0,0,0,.05); }
    .topbar .brand, .topbar a{ color: var(--primary) !important; }
    .badge, .pill{ background: var(--panel-alt); color: var(--text); border:1px solid var(--border); }
    a{ color: var(--primary); }
    /* tablas */
    table{ background: var(--panel); color: var(--text); border-color: var(--border); }
    thead th{ background: var(--panel-alt); }
    tbody tr:nth-child(even){ background: var(--bg-soft); }
    /* controles */
    .btn{ background: var(--panel); color: var(--text); border:1px solid var(--border); }
    .btn:hover{ background: var(--bg-soft); }
    .btn-brand, .btn.primary{ background: var(--primary); color: var(--primary-contrast); border-color: var(--primary); }
    .btn-brand:hover, .btn.primary:hover{ filter: brightness(0.95); }
    .btn.accent{ background: var(--accent); color: var(--accent-contrast); border-color: var(--accent); }
    .btn.danger{ background:#c62828; color:#fff; border-color:#c62828; }
    .btn.success{ background:#2c4735; color:#fff; border-color:#2c4735; }
    input, select, textarea{ background: var(--input-bg); color: var(--text); border:1px solid var(--border); }
    input::placeholder, textarea::placeholder{ color: var(--muted); }
    /* separadores y bordes */
    hr, .divider{ border-color: var(--border); }
    /* badges de totales / res√∫menes */
    .order-title, .summary-title{ color: var(--primary); }
    /* iconos triviales que tal vez se coloreaban en oscuro */
    .icon, svg{ fill: currentColor; color: var(--primary); }
  </style>


  <!-- Brand Light Theme (green contrast variant) -->
  <style id="brand-light-contrast">
    :root{
      /* Verde oscuro de marca para tipograf√≠a */
      --text:#2c4735;
      --primary:#2c4735;
      --primary-contrast:#ffffff;
      /* Fondos verde claro para alto contraste */
      --bg:#ecf2ef;          /* base (muy claro) */
      --bg-soft:#f6faf8;     /* a√∫n m√°s claro */
      --panel:#e6efe9;       /* paneles/cards */
      --panel-alt:#dfe9e3;   /* headers de tabla, chips */
      --accent:#bbc5bd;      /* salvia */
      --accent-contrast:#2c4735;
      --muted:#4e6a5b;
      --border:#cdd9d2;
      --input-bg:#ffffff;
      --success:#2c4735;
      --danger:#c62828;
      --warning:#b78129;
    }
    html, body{ background: var(--bg) !important; color: var(--text) !important; }
    .topbar, .wrap, main.view, section, aside, .card, .panel, .modal, .drawer{
      background: var(--panel) !important;
      color: var(--text) !important;
      border-color: var(--border) !important;
    }
    .topbar{ border-bottom:1px solid var(--border) !important; box-shadow:0 1px 6px rgba(0,0,0,.05) !important; }
    a, .brand, .order-title, .summary-title{ color: var(--primary) !important; }
    table{ background: var(--panel) !important; color: var(--text) !important; border-color: var(--border) !important; }
    thead th{ background: var(--panel-alt) !important; }
    tbody tr:nth-child(even){ background: var(--bg-soft) !important; }
    .badge, .pill{ background: var(--panel-alt) !important; color: var(--text) !important; border:1px solid var(--border) !important; }
    .btn{ background: var(--panel) !important; color: var(--text) !important; border:1px solid var(--border) !important; }
    .btn:hover{ background: var(--bg-soft) !important; }
    .btn-brand, .btn.primary{ background: var(--primary) !important; color: var(--primary-contrast) !important; border-color: var(--primary) !important; }
    .btn-brand:hover, .btn.primary:hover{ filter: brightness(0.95) !important; }
    .btn.accent{ background: var(--accent) !important; color: var(--accent-contrast) !important; border-color: var(--accent) !important; }
    input, select, textarea{ background: var(--input-bg) !important; color: var(--text) !important; border:1px solid var(--border) !important; }
    input::placeholder, textarea::placeholder{ color: var(--muted) !important; }
    hr, .divider{ border-color: var(--border) !important; }
    /* Si existe alguna clase tipo .dark o se aplican invertidos, neutralizamos */
    .dark, [data-theme="dark"]{ background: var(--panel) !important; color: var(--text) !important; }
  </style>


  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">


  <style id="typography-C">
    :root{
      --font-ui: 'Work Sans', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --radius: 12px;
    }
    html, body{ font-family: var(--font-ui); font-size: 15.5px; line-height: 1.38; }
    .card, .panel, .modal, .drawer, .btn{ border-radius: var(--radius); }
    table td, table th{ padding: 10px 12px; font-variant-numeric: tabular-nums; }
    .order-title, .summary-title{ font-weight: 700; letter-spacing: .2px; }
  </style>


  
  <style id="btn-contrast-fix">
    /* Bot√≥n EDITAR con contraste asegurado */
    .btn[data-variant="edit"]{
      background: #cfe5d8 !important;   /* verde muy claro */
      color: #2c4735 !important;         /* verde oscuro (texto) */
      border-color: #a9cbb7 !important;
    }
    .btn[data-variant="edit"]:hover{
      background: #bdddcd !important;
    }
    /* Asegurar contraste de .btn por defecto vs texto */
    .btn{
      background: var(--panel) !important;
      color: #2c4735 !important;
      border: 1px solid var(--border) !important;
    }
    /* P√≠ldoras/badges m√°s suaves */
    .badge, .pill{ background: var(--panel-alt) !important; border-color: var(--border) !important; }
  </style>

  <style id="theme-C-extras">
    .btn-brand, .btn.primary{ border-radius: 10px !important; }
    .topbar{ backdrop-filter: saturate(1.1); }
  </style>


  <style id="category-override">
    /* Fondo del bloque de categor√≠a (sube unos tonos) */
    .category{ background: #243a2f !important; border-color: #2e5442 !important; }
    .cat-head{ background: #243a2f !important; }
    /* T√≠tulo de categor√≠a (Empanadas, etc.) en verde claro del layout */
    .cat-name{ color: #e6efe9 !important; }
    /* Contador de productos: texto verde claro, sin pintura */
    .cat-count{
      background: transparent !important;
      color: #e6efe9 !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0 4px !important;
    }
  </style>


  <!-- Contrast boost for Variant C -->
  <style id="contrast-variant-C">
    /* Paleta afinada para mayor contraste */
    :root{
      --text:#1a2e24;             /* m√°s oscuro que #2c4735 para cuerpo */
      --heading:#0f1d16;          /* t√≠tulos s√∫per legibles */
      --muted:#2d4a3c;            /* secundarios con m√°s contraste */
      --primary:#2c4735;          /* sigue siendo el verde de marca */
      --primary-contrast:#ffffff; /* blanco sobre primario */
      --bg:#ecf2ef;               /* base */
      --bg-soft:#f6faf8;          /* alterno */
      --panel:#e6efe9;            /* panel */
      --panel-alt:#dfe9e3;        /* headers */
      --accent:#bbc5bd;           /* salvia claro */
      --accent-contrast:#1a2e24;  /* texto m√°s oscuro sobre acento claro */
      --border:#c9d6ce;
      --input-bg:#ffffff;
    }

    html, body{ color: var(--text) !important; }
    h1,h2,h3,.order-title,.summary-title{ color: var(--heading) !important; }

    /* Enlaces y acciones con mejor legibilidad */
    a{ color: var(--primary) !important; text-underline-offset: 2px; }
    a:hover{ filter: brightness(.92); }

    /* Tablas ‚Äî encabezados y celdas con contraste mejorado */
    table{ color: var(--text) !important; }
    thead th{ color: var(--heading) !important; background: var(--panel-alt) !important; }
    tbody td{ color: var(--text) !important; }

    /* Placeholders y textos secundarios */
    input::placeholder, textarea::placeholder{ color: var(--muted) !important; opacity: .95; }
    .small, .muted, .hint, .subtle{ color: var(--muted) !important; }

    /* Botones */
    .btn{ color: var(--text) !important; border-color: var(--border) !important; }
    .btn-brand, .btn.primary{ background: var(--primary) !important; color: var(--primary-contrast) !important; }
    .btn.accent{ background: var(--accent) !important; color: var(--accent-contrast) !important; }

    /* Categor√≠as: a√∫n m√°s contraste en cabecera y conteo */
    .category{ background: #223a2e !important; }  /* un poco m√°s oscuro */
    .cat-head{ background: #223a2e !important; }
    .cat-name{ color: #f0f7f3 !important; font-weight: 800 !important; }
    .cat-count{ color: #f0f7f3 !important; background: transparent !important; border: none !important; }

    /* Etiquetas/badges gen√©ricas */
    .badge, .pill{ color: var(--text) !important; background: var(--panel-alt) !important; border: 1px solid var(--border) !important; }

    /* Inputs con texto m√°s oscuro */
    input, select, textarea{ color: var(--heading) !important; }

    /* Tickets/impresiones (si hay inverso) forzar color alto contraste */
    @media print{
      body{ color: #000 !important; }
    }
  </style>


  <!-- Modal contrast fix (titles & labels) -->
  <style id="modal-contrast-fix">
    /* T√≠tulo del producto dentro del modal */
    .modal h1, .modal h2, .modal h3, .modal .title, .modal .product-title, .modal .order-title{
      color: #f0f7f3 !important;   /* muy claro para fondo oscuro */
      font-weight: 800 !important;
      letter-spacing: .2px;
    }
    /* Etiquetas/leyendas como "Cantidad" */
    .modal label, .modal .label, .modal .hint, .modal .muted, .modal .qty-label, .modal .legend{
      color: #e6efe9 !important;   /* claro */
      font-weight: 600;
    }
    /* Contenedores del modal mantienen fondo oscuro, pero paneles internos con leve borde */
    .modal, .drawer{
      background: #1b2227 !important; /* un tono menos negro para aumentar contraste con texto claro */
      color: #f0f7f3 !important;
    }
    .modal .card, .modal .panel{
      border-color: #2e5442 !important;
    }
    /* Inputs en modal: texto oscuro sobre fondo claro para buena lectura */
    .modal input, .modal select, .modal textarea{
      background: #ffffff !important;
      color: #1a2e24 !important;
      border: 1px solid #c9d6ce !important;
    }
    .modal .btn{
      color: #1a2e24 !important;
    }
    .modal .btn-brand, .modal .btn.primary{
      color: #ffffff !important;
    }
  </style>

</head>
<body>
  <header class="topbar">
    <div class="brand" id="navPedidos">
      <img src="logo.png" alt="Logo Pizza Gourmet Longchamps">
      <div>
        <div class="title">Pizza Gourmet Longchamps</div>
        <div class="subtitle">PIZZAS Y EMPANADAS GOURMET</div>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="btnHome" title="Volver al men√∫ principal">Men√∫ principal</button>
      <button class="btn" id="reloadBtn" title="Recargar datos">&#x21bb; Recargar</button>
      <button class="btn" id="btnResumen" title="Resumen del d√≠a">Resumen</button>
      <a class="btn btn-brand" id="editLink" href="#" target="_blank" rel="noopener">Editar precios</a>
    </div>
  </header>

  <!-- Subnav (Resumen/D√≠as) -->
  <div class="subnav" id="subnav" style="display:none">
    <button class="chip active" id="tabResumen">Pedidos del d√≠a</button>
    <button class="chip" id="tabDias">D√≠as</button>
  </div>

  <!-- PEDIDOS (MEN√ö PRINCIPAL) -->
  <main class="wrap view active" id="viewPedidos">
    <section class="left">
      <div class="toolbar">
        <input id="search" class="search" type="search" placeholder="Buscar producto‚Ä¶">
        <span class="badge" id="countBadge">0 productos</span>
      </div>
      <div id="categories"></div>
      <div class="small" id="status"></div>
    </section>

    <aside class="right">
      <div class="order-title">Comanda</div>
      <div class="order-id" id="orderIdBadge" style="display:none"></div>
      <div class="small">Click en un producto para a√±adirlo. Ajust√° cantidades en la lista.</div>

      <div id="orderList" class="order-list"></div>

      <div class="totals">
        <span>Total</span>
        <span id="total" class="total">$ 0,00</span>
      </div>

      <div class="field">
        <label for="addr" class="small">Direcci√≥n</label>
        <input id="addr" class="in" type="text" placeholder="Calle y n√∫mero, piso, etc.">
      </div>
      <div class="field">
        <label for="time" class="small">Horario de entrega</label>
        <input id="time" class="in" type="time">
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-danger" id="clearBtn">Vaciar</button>
        <button class="btn" id="printBtn">Imprimir</button>
      </div>
      <div class="small">* Imprimir guarda/actualiza y limpia la comanda.</div>
    </aside>
  </main>

  <!-- RESUMEN -->
  <main class="wrap view" id="viewResumen">
    <section class="left">
      <h3 style="margin:0 0 10px">Pedidos del d√≠a</h3>
      <div class="small">‚Äúüñ®‚Äù reimprime el ticket (mismo ID). ‚Äú‚úèÔ∏è Editar‚Äù reabre para modificar e imprimir de nuevo.</div>
      <div style="overflow:auto">
        <table id="ordersTable">
          <thead><tr><th>ID</th><th>Hora</th><th>Direcci√≥n</th><th>Entrega</th><th>Total</th><th>Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <aside class="right">
      <div class="order-title">Resumen del d√≠a</div>
      <div id="summaryBox" class="small">Sin datos a√∫n.</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="btnRecalc">Recalcular</button>
        <button class="btn btn-brand" id="btnFinalizarDia">Finalizar DIA</button>
        <button class="btn" id="btnExportarExcel" title="Descargar Excel">Exportar Excel</button>
      </div>
      <div class="small">‚ÄúFinalizar DIA‚Äù imprime y guarda el cierre en ‚ÄúD√≠as‚Äù.</div>
    </aside>
  </main>

  <!-- D√çAS -->
  <main class="wrap view" id="viewDias">
    <section class="left">
      <h3 style="margin:0 0 10px">Cierres registrados</h3>
      <div style="overflow:auto">
        <table id="daysTable">
          <thead><tr><th>Fecha</th><th>Pedidos</th><th>Ingresos</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
    <aside class="right">
      <div class="order-title">Acciones</div>
      <div class="small">Pod√©s limpiar el historial de cierres sin afectar los pedidos del d√≠a actual.</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
        <button class="btn btn-danger" id="btnLimpiarDias">Limpiar D√çAS</button>
      </div>
    </aside>
  </main>

  <!-- MODAL -->
  <div class="modal" id="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="title" id="modalTitle">A√±adir producto</div>
      <div class="size-grid" id="sizeGrid"></div>
      <div class="qty-row">
        <span>Cantidad</span>
        <div class="qty-box">
          <button class="btn" id="mMinus" style="padding:4px 8px">‚àí</button>
          <input id="qtyInp" type="number" min="1" value="1">
          <button class="btn" id="mPlus" style="padding:4px 8px">+</button>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" id="cancelBtn">Cancelar</button>
      </div>
    </div>
  </div>


  <script>
    // Registrar Service Worker para habilitar instalaci√≥n PWA
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(console.error);
      });
    }
  </script>

<script>
(function(){
  // ====== CONFIG ======
  const SHEET_ID = "1vq34RVaka0N-5kX6BNXQzVrcjRKPvASZ1xJU4K6tg8M";
  const GID = null;
  const SHEET_EDIT_URL = "https://docs.google.com/spreadsheets/d/1vq34RVaka0N-5kX6BNXQzVrcjRKPvASZ1xJU4K6tg8M/edit?usp=sharing";

  // ====== STATE ======
  let byCategory = [];
  let cart = [];
  let currentItem = null;
  let currentEditingId = null;

  // localStorage keys
  const LS_CART   = "pgl_cart";
  const LS_ORDERS = "pgl_orders";
  const LS_DAYS   = "pgl_days";

  // ====== HELPERS ======
  const qs = (s) => document.querySelector(s);
  const qsa = (s) => Array.from(document.querySelectorAll(s));
  const nf = new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',minimumFractionDigits:2});
  const todayStr = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };
  const uid = () => 'PGL-' + Math.random().toString(36).slice(2,8).toUpperCase();

  function normalizeKey(s){ return String(s||"").trim().toLowerCase()
    .replace(/\s+/g," ").replace(/[√°√†√§]/g,"a").replace(/[√©√®√´]/g,"e").replace(/[√≠√¨√Ø]/g,"i").replace(/[√≥√≤√∂]/g,"o")
    .replace(/[√∫√π√º]/g,"u").replace(/√±/g,"n"); }
  function buildGVizUrl(useGid=false){
    return useGid && GID
      ? `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${encodeURIComponent(GID)}&tqx=out:json`
      : `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
  }
  function setStatus(msg){ qs("#status").textContent = msg || ""; }

  // ====== Sheet mapping ======
  function buildColMap(table){
    const cols=(table.cols||[]).map((c,i)=>({i,key:normalizeKey(c.label||"")}));
    const find=(...names)=>{ const set=names.map(n=>normalizeKey(n)); const hit=cols.find(c=>set.includes(c.key)); return hit?hit.i:null; };
    let m={categoria:find("categoria"), producto:find("producto"), tamano:find("tamano","tama√±o"), precio:find("precio")};
    if([m.categoria,m.producto,m.tamano,m.precio].some(v=>v==null)) m={categoria:0,producto:1,tamano:2,precio:3};
    return m;
  }
  function mapRow(row,map){
    const c=row.c||[];
    return {
      categoria:String(c[map.categoria]?.v ?? "").trim(),
      producto :String(c[map.producto]?.v ?? "").trim(),
      tamano   :String(c[map.tamano]?.v ?? "").trim(),
      precio   :Number(c[map.precio]?.v ?? c[map.precio]?.f ?? 0)
    };
  }
  function group(rows){
    const byName=new Map();
    for(const r of rows){
      if(!r.producto) continue;
      const key=r.producto.trim();
      if(!byName.has(key)) byName.set(key,{producto:key,categoria:r.categoria||"",variantes:[]});
      byName.get(key).variantes.push({tamano:r.tamano||"",precio:Number(r.precio)||0,categoria:r.categoria||""});
    }
    const list=[...byName.values()];
    list.forEach(p=>p.variantes.sort((a,b)=>(a.precio||0)-(b.precio||0)));
    list.sort((a,b)=>a.producto.localeCompare(b.producto,'es'));
    const cats=new Map();
    for(const it of list){ const cat=it.categoria||"Otros"; if(!cats.has(cat)) cats.set(cat,[]); cats.get(cat).push(it); }
    return [...cats.entries()].map(([categoria,items])=>({categoria,items})).sort((a,b)=>a.categoria.localeCompare(b.categoria,'es'));
  }

  // ====== Render productos ======
  function renderCategories(catBlocks){
    const root=qs("#categories"); root.innerHTML="";
    catBlocks.forEach(block=>{
      const wrap=document.createElement("section"); wrap.className="category";
      const head=document.createElement("div"); head.className="cat-head";
      head.innerHTML=`<div class="cat-name">${block.categoria}</div><div class="badge">${block.items.length} producto${block.items.length===1?"":"s"}</div>`;
      const grid=document.createElement("div"); grid.className="grid";
      block.items.forEach(item=>{
        const card=document.createElement("button");
        card.className="card"; card.type="button"; card.textContent=item.producto;
        card.addEventListener("click", ()=> openModal(item));
        grid.appendChild(card);
      });
      wrap.append(head,grid); root.appendChild(wrap);
    });
    const total=catBlocks.reduce((a,b)=>a+b.items.length,0);
    qs("#countBadge").textContent=`${total} producto${total===1?"":"s"}`;
  }

  // ====== Carrito / Comanda ======
  function renderCart(){
    const list=qs("#orderList"); list.innerHTML="";
    cart.forEach((it,idx)=>{
      const line=document.createElement("div"); line.className="line";
      const left=document.createElement("div"); left.innerHTML=`<h4>${it.producto}</h4><div class="muted">${it.tamano||"‚Äî"}</div>`;
      const qty=document.createElement("div"); qty.className="qty";
      const minus=document.createElement("button"); minus.textContent="‚àí";
      const span=document.createElement("span"); span.textContent=it.cantidad;
      const plus=document.createElement("button"); plus.textContent="+";
      minus.addEventListener("click",()=>changeQty(idx,-1)); plus.addEventListener("click",()=>changeQty(idx,+1));
      qty.append(minus,span,plus);
      const price=document.createElement("div"); price.className="price"; price.textContent=nf.format(it.cantidad*it.precio);
      const rm=document.createElement("button"); rm.className="remove"; rm.title="Quitar"; rm.textContent="‚úï"; rm.addEventListener("click",()=>removeLine(idx));
      line.append(left,qty,price,rm); list.appendChild(line);
    });
    const total=cart.reduce((acc,it)=>acc+it.cantidad*it.precio,0);
    qs("#total").textContent=nf.format(total);
  }
  function changeQty(i,d){ cart[i].cantidad+=d; if(cart[i].cantidad<=0) cart.splice(i,1); renderCart(); persistCart(); }
  function removeLine(i){ cart.splice(i,1); renderCart(); persistCart(); }
  function addToCart(producto,tamano,precio,cantidad){
    const k=cart.findIndex(it=>it.producto===producto&&it.tamano===tamano&&it.precio===precio);
    if(k>=0) cart[k].cantidad+=cantidad; else cart.push({producto,tamano,precio,cantidad});
    renderCart(); persistCart();
  }

  // ====== Modal tama√±os ======
  function openModal(item){
    currentItem=item;
    qs("#modalTitle").textContent=item.producto;
    qs("#qtyInp").value=1;
    const grid=qs("#sizeGrid"); grid.innerHTML="";
    const vars=item.variantes.length?item.variantes:[{tamano:"√önico",precio:item.variantes?.[0]?.precio||0}];
    vars.forEach(v=>{
      const btn=document.createElement("button"); btn.className="size-btn"; btn.type="button";
      const label=v.tamano||"√önico"; btn.innerHTML=`${label}<strong>${nf.format(Number(v.precio)||0)}</strong>`;
      btn.addEventListener("click",()=>{
        const qty=Math.max(1,parseInt(qs("#qtyInp").value||"1",10));
        addToCart(item.producto,label,Number(v.precio)||0,qty);
        closeModal();
      });
      grid.appendChild(btn);
    });
    qs("#modal").classList.add("open"); qs("#modal").setAttribute("aria-hidden","false");
  }
  function closeModal(){ qs("#modal").classList.remove("open"); qs("#modal").setAttribute("aria-hidden","true"); currentItem=null; }
  qs("#cancelBtn").addEventListener("click",closeModal);
  qs("#modal").addEventListener("click",(e)=>{ if(e.target===e.currentTarget) closeModal(); });
  window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeModal(); });
  qs("#mMinus").addEventListener("click",()=>{ const el=qs("#qtyInp"); el.value=Math.max(1,(parseInt(el.value||"1",10)-1)); });
  qs("#mPlus").addEventListener("click",()=>{ const el=qs("#qtyInp"); el.value=Math.max(1,(parseInt(el.value||"1",10)+1)); });

  // ====== Storage ======
  function persistCart(){
    localStorage.setItem(LS_CART, JSON.stringify({
      cart, addr:qs("#addr").value, time:qs("#time").value, editingId: currentEditingId
    }));
  }
  function restoreCart(){
    try{
      const raw=JSON.parse(localStorage.getItem(LS_CART)||"{}");
      cart=raw.cart||[]; qs("#addr").value=raw.addr||""; qs("#time").value=raw.time||"";
      currentEditingId = raw.editingId || null;
      refreshOrderIdBadge();
    }catch{ cart=[]; currentEditingId=null; }
    renderCart();
  }
  function getOrders(){ try{ return JSON.parse(localStorage.getItem(LS_ORDERS)||"[]"); }catch{ return []; } }
  function setOrders(arr){ localStorage.setItem(LS_ORDERS, JSON.stringify(arr)); }
  function getDays(){ try{ return JSON.parse(localStorage.getItem(LS_DAYS)||"[]"); }catch{ return []; } }
  function setDays(arr){ localStorage.setItem(LS_DAYS, JSON.stringify(arr)); }

  // ====== Fetch Sheet ======
  async function fetchSheet(){
    setStatus("Cargando productos‚Ä¶");
    try{
      const res=await fetch(buildGVizUrl(Boolean(GID)));
      if(!res.ok) throw new Error("No se pudo leer la hoja.");
      const text=await res.text();
      const jsonStr=text.replace(/^[\s\S]*setResponse\(/,"").replace(/\);?\s*$/,"");
      const data=JSON.parse(jsonStr);
      const table=data.table;
      const map=buildColMap(table);
      const rows=(table.rows||[]).map(r=>mapRow(r,map)).filter(r=>r.producto);
      byCategory=group(rows);
      renderCategories(byCategory);
      setStatus(byCategory.length?"":"No se encontraron productos.");
    }catch(err){ console.error(err); setStatus("Error al cargar datos. Revis√° permisos del Sheet."); }
  }

  // ====== Buscar ======
  qs("#search").addEventListener("input",(e)=>{
    const q=normalizeKey(e.target.value);
    const filtered=!q?byCategory:byCategory.map(c=>({categoria:c.categoria,items:c.items.filter(p=>normalizeKey(p.producto).includes(q))})).filter(c=>c.items.length);
    renderCategories(filtered);
  });

  // ====== Pedido / ID ======
  function refreshOrderIdBadge(){
    const badge = qs("#orderIdBadge");
    if(currentEditingId){ badge.textContent = `ID: ${currentEditingId}`; badge.style.display = "block"; }
    else { badge.textContent = ""; badge.style.display = "none"; }
  }
  function buildOrderFromUI(){
    const total=cart.reduce((acc,it)=>acc+it.cantidad*it.precio,0);
    return {
      id: currentEditingId || uid(),
      dateISO: new Date().toISOString(),
      dateKey: todayStr(),
      address: qs("#addr").value.trim(),
      delivery: qs("#time").value || "",
      items: JSON.parse(JSON.stringify(cart)),
      total
    };
  }
  function upsertOrder(order){
    const all=getOrders();
    const idx=all.findIndex(o=>o.id===order.id);
    if(idx>=0){ all[idx]=order; } else { all.push(order); }
    setOrders(all);
  }

  // ====== Imprimir ticket (guarda/actualiza y limpia) ======
  function printTicketFlow(){
    if(!cart.length){ alert("La comanda est√° vac√≠a."); return; }

    // 1) Guardar/actualizar pedido y fijar ID visible
    const order = buildOrderFromUI();
    upsertOrder(order);
    currentEditingId = order.id;
    refreshOrderIdBadge();
    persistCart();

    const idNode = qs("#orderIdBadge");
    idNode.textContent = `ID: ${order.id}`;
    idNode.style.display = "block";

    // 2) Preparar panel para ticket
    const aside = document.querySelector("#viewPedidos .right");
    aside.classList.add("ticket");

    // 3) Imprimir y limpiar SIEMPRE (aunque el usuario cancele)
    let cleaned = false;
    const cleanupAfterPrint = () => {
      if(cleaned) return; cleaned = true;
      // Quitar modo ticket y limpiar comanda
      aside.classList.remove("ticket");
      cart = [];
      qs("#addr").value = "";
      qs("#time").value = "";
      currentEditingId = null;
      renderCart();
      refreshOrderIdBadge();
      persistCart();
    };

    // Usar onafterprint cuando est√© disponible
    const prevAfter = window.onafterprint;
    window.onafterprint = function(){
      cleanupAfterPrint();
      // restaurar handler previo si lo hab√≠a
      window.onafterprint = prevAfter || null;
    };

    // Fallback por si onafterprint no dispara (algunos navegadores/entornos)
    const fallback = setTimeout(()=>{
      cleanupAfterPrint();
    }, 15000);

    // Llamada s√≠ncrona para evitar bloqueos del di√°logo de impresi√≥n
    try {
      window.print();
    } finally {
      if(cleaned){ clearTimeout(fallback); }
    }
  }

  qs("#printBtn").addEventListener("click", printTicketFlow);

  qs("#clearBtn").addEventListener("click",()=>{
    if(confirm("¬øVaciar comanda?")){
      cart=[]; qs("#addr").value=""; qs("#time").value="";
      currentEditingId = null; refreshOrderIdBadge();
      renderCart(); persistCart();
    }
  });

  // ====== Resumen del d√≠a ======
  function ordersOfToday(){ const all=getOrders(); const key=todayStr(); return all.filter(o=>o.dateKey===key); }
  function aggregateProducts(orders){
    const map=new Map(); let total=0;
    for(const o of orders){
      total+=o.total;
      for(const it of o.items){
        const k=it.producto+"|"+(it.tamano||"");
        const prev=map.get(k)||{producto:it.producto,tamano:it.tamano||"",cantidad:0,importe:0};
        prev.cantidad+=it.cantidad; prev.importe+=it.cantidad*it.precio; map.set(k,prev);
      }
    }
    return { products:[...map.values()], total };
  }

  function renderOrdersTable(){
    const tb=qs("#ordersTable tbody"); tb.innerHTML="";
    const list=ordersOfToday();
    list.forEach((o)=>{
      const tr=document.createElement("tr");
      const time=new Date(o.dateISO).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
      tr.innerHTML=`
        <td>${o.id}</td>
        <td>${time}</td>
        <td><input data-id="${o.id}" data-k="address" class="in" value="${o.address||""}"></td>
        <td><input data-id="${o.id}" data-k="delivery" class="in" type="time" value="${o.delivery||""}"></td>
        <td>${nf.format(o.total)}</td>
        <td style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn btn-ghost" data-act="edit"  data-id="${o.id}">‚úèÔ∏è Editar</button>
          <button class="btn btn-ghost" data-act="print" data-id="${o.id}">üñ®</button>
          <button class="btn btn-danger" data-act="del"   data-id="${o.id}">üóë</button>
        </td>`;
      tb.appendChild(tr);
    });

    tb.querySelectorAll('input.in').forEach(inp=>{
      inp.addEventListener('change',(e)=>{
        const id=e.target.dataset.id, k=e.target.dataset.k;
        const all=getOrders(); const i=all.findIndex(x=>x.id===id);
        if(i>=0){ all[i][k]=e.target.value; setOrders(all); }
      });
    });

    tb.querySelectorAll('button[data-act]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const act=e.currentTarget.dataset.act; const id=e.currentTarget.dataset.id;
        const all=getOrders(); const i=all.findIndex(x=>x.id===id); if(i<0) return;
        const o=all[i];

        if(act==="del"){
          if(confirm("¬øEliminar pedido?")){ all.splice(i,1); setOrders(all); renderOrdersTable(); renderSummaryBox(); }
          return;
        }

        if(act==="edit"){
          cart=o.items; qs("#addr").value=o.address||""; qs("#time").value=o.delivery||"";
          currentEditingId=o.id; refreshOrderIdBadge(); renderCart(); persistCart();
          showView("#viewPedidos");
          document.querySelector("#viewPedidos .right").scrollIntoView({behavior:"smooth",block:"start"});
          return;
        }

        if(act==="print"){
          cart=o.items; qs("#addr").value=o.address||""; qs("#time").value=o.delivery||"";
          currentEditingId=o.id; refreshOrderIdBadge(); renderCart(); persistCart();
          showView("#viewPedidos");
          setTimeout(printTicketFlow, 0);
          return;
        }
      });
    });
  }

  function renderSummaryBox(){
    const list=ordersOfToday();
    const {products,total}=aggregateProducts(list);
    if(!list.length){ qs("#summaryBox").innerHTML="Sin pedidos hoy."; return; }
    let html=`<div class="small">Pedidos: <strong>${list.length}</strong></div>`;
    html+=`<div class="small">Ingresos: <strong>${nf.format(total)}</strong></div>`;
    html+=`<div style="margin-top:8px"><strong>Productos vendidos</strong></div>`;
    html+=`<div class="small">`;
    products.sort((a,b)=> a.producto.localeCompare(b.producto,'es') || (a.tamano||"").localeCompare(b.tamano||"",'es'));
    for(const p of products){
      const label = p.tamano ? `${p.producto} (${p.tamano})` : p.producto;
      html+=`<div>${label}: <strong>${p.cantidad}</strong></div>`;
    }
    html+=`</div>`;
    qs("#summaryBox").innerHTML=html;
  }

  qs("#btnRecalc").addEventListener("click", renderSummaryBox);

  // ====== Finalizar D√≠a (imprime resumen y guarda en D√≠as) ======
  qs("#btnFinalizarDia").addEventListener("click", ()=>{
    const todays = ordersOfToday();
    if(!todays.length){ alert("No hay pedidos para cerrar hoy."); return; }
    const {products,total}=aggregateProducts(todays);

    const days=getDays();
    days.push({ date: todayStr(), orders: todays.length, total, products, savedAt: new Date().toISOString() });
    setDays(days);

    const aside=document.querySelector("#viewResumen .right");
    const prevHTML=aside.innerHTML;
    aside.innerHTML=`<h2>Resumen del d√≠a ${todayStr()}</h2>
      <div>Pedidos: ${todays.length}</div>
      <div>Total: ${nf.format(total)}</div>
      <hr/>
      <div><strong>Productos vendidos</strong></div>
      ${products.map(p=>`<div>${p.producto}${p.tamano?` (${p.tamano})`:``}: ${p.cantidad}</div>`).join("")}
    `;
    aside.classList.add("ticket"); window.print(); aside.classList.remove("ticket");
    aside.innerHTML=prevHTML;

    const all=getOrders();
    const remaining=all.filter(o=> o.dateKey!==todayStr());
    setOrders(remaining);

    renderOrdersTable(); renderSummaryBox(); renderDaysTable();
    alert("D√≠a finalizado: resumen guardado en D√çAS y pedidos del d√≠a borrados.");
  });

  // ====== D√≠as (lista y limpiar historial) ======
  function renderDaysTable(){
    const tb=qs("#daysTable tbody"); tb.innerHTML="";
    const days=getDays();
    days.forEach(d=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${d.date}</td><td>${d.orders}</td><td>${nf.format(d.total)}</td>`;
      tr.addEventListener("click", ()=>{ alert(`D√≠a ${d.date}\nPedidos: ${d.orders}\nIngresos: ${nf.format(d.total)}`); });
      tb.appendChild(tr);
    });
  }

  // BORRAR TODO EL REGISTRO (cierres + pedidos)
  qs("#btnLimpiarDias").addEventListener("click", ()=>{
    if(confirm("¬øVaciar por completo el registro? (Cierres + Pedidos guardados)")){
      localStorage.setItem(LS_DAYS, JSON.stringify([]));
      localStorage.setItem(LS_ORDERS, JSON.stringify([]));
      renderDaysTable();
      renderOrdersTable();
      renderSummaryBox();
      showView("#viewDias");
      alert("Registro COMPLETO limpiado.");
    }
  });

  // ====== NAV ======
  function showView(id){
    qsa(".view").forEach(v=>v.classList.remove("active"));
    qs(id).classList.add("active");
    qs("#subnav").style.display = (id==="#viewPedidos") ? "none" : "flex";
  }
  const goHome=()=> showView("#viewPedidos");

  qs("#btnResumen").addEventListener("click", ()=>{ showView("#viewResumen"); renderOrdersTable(); renderSummaryBox(); });
  qs("#navPedidos").addEventListener("click", goHome);
  qs("#btnHome").addEventListener("click", goHome);
  qs("#tabResumen").addEventListener("click", ()=>{ qs("#tabResumen").classList.add("active"); qs("#tabDias").classList.remove("active"); showView("#viewResumen"); renderOrdersTable(); renderSummaryBox(); });
  qs("#tabDias").addEventListener("click", ()=>{ qs("#tabDias").classList.add("active"); qs("#tabResumen").classList.remove("active"); showView("#viewDias"); renderDaysTable(); });

  // ====== Top ======
  qs("#editLink").href=SHEET_EDIT_URL;
  qs("#reloadBtn").addEventListener("click", fetchSheet);

  // ====== INIT ======
  restoreCart();
  fetchSheet();

  // ====== Exportar Excel (no rompe flujos) ======
  function exportExcel(){
    try{
      // Utiles locales (reusan helpers existentes)
      const today = (function(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; })();
      const monthKey = (s)=> (String(s||"").slice(0,7));

      // 1) Pedidos del d√≠a
      const list = ordersOfToday();
      const rowsPedidos = list.map(o=>{
        const hora = o.dateISO ? new Date(o.dateISO).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"}) : "";
        const itemsTxt = (o.items||[]).map(it=>{
          const sub = Number(it.cantidad||0) * Number(it.precio||0);
          const t   = it.tamano ? ` (${it.tamano})` : "";
          return `${it.cantidad||0}√ó ${it.producto||""}${t} = ${sub.toFixed(2)}`;
        }).join(" | ");
        return {
          ID: o.id || "",
          Fecha: o.dateKey || "",
          Hora: hora,
          Direcci√≥n: o.address || "",
          Entrega: o.delivery || "",
          Total: Number(Number(o.total||0).toFixed(2)),
          Items: itemsTxt
        };
      });

      // 2) Productos vendidos (d√≠a)
      const { products, total } = aggregateProducts(list);
      const rowsProductosDia = (products||[])
        .sort((a,b)=> a.producto.localeCompare(b.producto,'es') || (a.tamano||"").localeCompare(b.tamano||"",'es'))
        .map(p=>({ Producto:p.producto, Tama√±o:p.tamano||"", Cantidad:p.cantidad, Importe:Number(p.importe.toFixed(2)) }));

      // 3) Resumen mensual desde D√çAS
      const days = getDays();
      const byMonth = new Map();
      for(const d of (days||[])){
        const mk = monthKey(d.date);
        if(!mk) continue;
        const prev = byMonth.get(mk) || {Mes: mk, Pedidos:0, Ingresos:0};
        prev.Pedidos += Number(d.orders||0);
        prev.Ingresos += Number(d.total||0);
        byMonth.set(mk, prev);
      }
      const rowsMensual = [...byMonth.values()]
        .sort((a,b)=> a.Mes.localeCompare(b.Mes,'es'))
        .map(r=>({ Mes:r.Mes, Pedidos:r.Pedidos, Ingresos:Number(r.Ingresos.toFixed(2)) }));

      // 4) Pedidos hist√≥ricos (todos)
      const all = getOrders();
      const rowsPedidosAll = (all||[]).map(o=>{
        const hora = o.dateISO ? new Date(o.dateISO).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"}) : "";
        const itemsTxt = (o.items||[]).map(it=>{
          const sub = Number(it.cantidad||0) * Number(it.precio||0);
          const t   = it.tamano ? ` (${it.tamano})` : "";
          return `${it.cantidad||0}√ó ${it.producto||""}${t} = ${sub.toFixed(2)}`;
        }).join(" | ");
        return {
          ID: o.id || "",
          Fecha: o.dateKey || "",
          Hora: hora,
          Direcci√≥n: o.address || "",
          Entrega: o.delivery || "",
          Total: Number(Number(o.total||0).toFixed(2)),
          Items: itemsTxt
        };
      }).sort((a,b)=> a.Fecha.localeCompare(b.Fecha) || a.Hora.localeCompare(b.Hora));

      // 5) Productos hist√≥ricos totales
      const mapAll = new Map(); let _tot=0;
      for(const o of (all||[])){
        _tot += Number(o.total||0);
        for(const it of (o.items||[])){
          const k=(it.producto||"")+"|"+(it.tamano||"");
          const prev=mapAll.get(k)||{Producto:it.producto||"",Tama√±o:it.tamano||"",Cantidad:0,Importe:0};
          const c=Number(it.cantidad||0), p=Number(it.precio||0);
          prev.Cantidad += c; prev.Importe += c*p; mapAll.set(k,prev);
        }
      }
      const rowsProductosAll = [...mapAll.values()]
        .sort((a,b)=> a.Producto.localeCompare(b.Producto,'es') || (a.Tama√±o||"").localeCompare(b.Tama√±o||"",'es'))
        .map(r=>({Producto:r.Producto, Tama√±o:r.Tama√±o, Cantidad:r.Cantidad, Importe:Number(r.Importe.toFixed(2))}));

      // 6) Productos por mes (Mes √ó Producto √ó Tama√±o)
      const pivot = new Map();
      for(const o of (all||[])){
        const mk = monthKey(o.dateKey||"");
        for(const it of (o.items||[])){
          const key = `${mk}|${it.producto||""}|${it.tamano||""}`;
          const prev = pivot.get(key) || {Mes: mk||"", Producto: it.producto||"", Tama√±o: it.tamano||"", Cantidad:0, Importe:0};
          const c = Number(it.cantidad||0), p = Number(it.precio||0);
          prev.Cantidad += c; prev.Importe += c*p;
          pivot.set(key, prev);
        }
      }
      const rowsProdMes = [...pivot.values()]
        .sort((a,b)=> a.Mes.localeCompare(b.Mes) || a.Producto.localeCompare(b.Producto,'es') || (a.Tama√±o||"").localeCompare(b.Tama√±o||"",'es'))
        .map(r=>({ Mes:r.Mes, Producto:r.Producto, Tama√±o:r.Tama√±o, Cantidad:r.Cantidad, Importe:Number(r.Importe.toFixed(2)) }));

      // 7) D√çAS (detalle crudo)
      const rowsDias = (days||[]).map(d=>({
        Fecha: d.date || "",
        Pedidos: Number(d.orders||0),
        Ingresos: Number(Number(d.total||0).toFixed(2))
      })).sort((a,b)=> a.Fecha.localeCompare(b.Fecha));

      // Workbook
      const wb = XLSX.utils.book_new();

      function js2sheet(rows, cols){
        const ws = XLSX.utils.json_to_sheet(rows);
        if(cols) ws['!cols']=cols;
        return ws;
      }

      XLSX.utils.book_append_sheet(wb, js2sheet(rowsPedidos,      [{wch:14},{wch:12},{wch:8},{wch:28},{wch:12},{wch:12},{wch:60}]), "Pedidos del d√≠a");
      XLSX.utils.book_append_sheet(wb, js2sheet(rowsProductosDia, [{wch:30},{wch:12},{wch:10},{wch:12}]), "Productos (d√≠a)");
      XLSX.utils.book_append_sheet(wb, js2sheet(rowsMensual,      [{wch:10},{wch:10},{wch:14}]), "Resumen mensual");
      XLSX.utils.book_append_sheet(wb, js2sheet(rowsPedidosAll,   [{wch:14},{wch:12},{wch:8},{wch:28},{wch:12},{wch:12},{wch:60}]), "Pedidos hist√≥ricos");
      XLSX.utils.book_append_sheet(wb, js2sheet(rowsProductosAll, [{wch:30},{wch:12},{wch:10},{wch:12}]), "Productos hist√≥ricos");
      XLSX.utils.book_append_sheet(wb, js2sheet(rowsProdMes,      [{wch:10},{wch:30},{wch:12},{wch:10},{wch:12}]), "Productos por mes");
      XLSX.utils.book_append_sheet(wb, js2sheet(rowsDias,         [{wch:12},{wch:10},{wch:14}]), "D√çAS (detalle)");

      const fileName = `PGL-Export_COMPLETO_${today}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }catch(err){
      console.error(err);
      alert("No se pudo exportar el Excel. Avisame si persiste.");
    }
  }

  const btnX = document.getElementById("btnExportarExcel");
  if(btnX){ btnX.addEventListener("click", exportExcel); }

  // ====== TESTS R√ÅPIDOS (consola) ======
  console.group("Smoke tests");
  try{ console.assert(typeof qs==="function" && qs("#viewPedidos"), "qs disponible y #viewPedidos existe"); }catch(e){ console.error(e); }
  try{ const _u=uid(); console.assert(_u.startsWith("PGL-"), "uid con prefijo PGL-"); }catch(e){ console.error(e); }
  try{ console.assert(typeof printTicketFlow==="function", "printTicketFlow existe"); }catch(e){ console.error(e); }
  // Tests adicionales no destructivos
  try{ console.assert(typeof window.onafterprint !== 'undefined', 'onafterprint soportado o definible'); }catch(e){ console.error(e); }
  try{ console.assert(Array.isArray(JSON.parse(localStorage.getItem(LS_DAYS)||'[]')), 'LS_DAYS es array'); }catch(e){ console.error(e); }
  console.groupEnd();
})();
</script>

    <script>
      // Etiquetar botones "Editar" para poder cambiar su color sin romper nada
      (function(){
        function tagEdits(){
          var btns = document.querySelectorAll('button, a.btn');
          btns.forEach(function(b){
            var t = (b.textContent || '').trim().toLowerCase();
            if(t.includes('editar')){ b.setAttribute('data-variant','edit'); }
          });
        }
        if (document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', tagEdits);
        } else {
          tagEdits();
        }
      })();
    </script>
    

  <script>
    // Marcar contador dentro del head de categor√≠a y normalizar colores
    (function(){
      function tagCategoryCounts(){
        document.querySelectorAll('.cat-head').forEach(function(head){
          // 1) T√≠tulo: aseguro clase .cat-name al primer h3/span fuerte
          var title = head.querySelector('.cat-name') || head.querySelector('h3, .title, strong, span');
          if(title){ title.classList.add('cat-name'); }
          // 2) Buscar posibles contadores: .pill, .badge o spans con d√≠gitos
          var candidates = head.querySelectorAll('.pill, .badge, span, small, b, strong, em');
          candidates.forEach(function(el){
            var t = (el.textContent||'').trim();
            if(/^[0-9]+$/.test(t) || /^[0-9]+\s*(prod|items|productos)?$/i.test(t)){
              el.classList.add('cat-count');
            }
          });
        });
      }
      if(document.readyState==='loading'){
        document.addEventListener('DOMContentLoaded', tagCategoryCounts);
      }else{
        tagCategoryCounts();
      }
    })();
  </script>

</body>
</html>
