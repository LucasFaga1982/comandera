<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comandas · Pizza Gourmet Longchamps</title>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#111827;       /* gray-900 */
      --card:#1f2937;        /* gray-800 */
      --accent:#ef9963;      /* Naty palette */
      --accent-2:#f3efdc;
      --ink:#e5e7eb;         /* gray-200 */
      --muted:#9ca3af;       /* gray-400 */
      --ok:#22c55e;
      --danger:#ef4444;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#0b1225,#0f172a);
      color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;
    }

    /* Top bar */
    .topbar{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px; background:#0b1327e6; backdrop-filter: blur(6px);
      border-bottom:1px solid #1f2a44;
    }
    .brand{
      display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.4px;
    }
    .brand .logo{
      width:36px; height:36px; border-radius:12px; background:radial-gradient(circle at 30% 30%, #ef9963, #4d3069 70%); box-shadow: var(--shadow);
    }
    .actions{display:flex; gap:8px}
    .btn{
      border:1px solid #2a3554; background:var(--card); color:var(--accent-2);
      padding:10px 14px; border-radius:12px; cursor:pointer;
      box-shadow: var(--shadow); font-weight:600;
    }
    .btn:hover{border-color:#3d4b78}
    .btn-accent{
      background:linear-gradient(135deg,#ef9963,#4d3069); color:white; border:none;
    }
    .btn-danger{background:#7f1d1d; border:1px solid #b91c1c; color:#fecaca}
    .btn-ghost{background:transparent; border:1px dashed #374151; color:#cbd5e1}

    /* Layout */
    .wrap{
      display:grid; grid-template-columns: 3fr 1.2fr; gap:18px;
      max-width:1400px; margin:16px auto; padding:16px;
    }
    .left{
      min-height:70vh; background:var(--panel); border-radius:var(--radius);
      padding:16px; box-shadow: var(--shadow);
    }
    .right{
      position:sticky; top:76px; align-self:start;
      background:var(--panel); border-radius:var(--radius);
      padding:18px; box-shadow: var(--shadow);
      display:flex; flex-direction:column; gap:12px; max-height: calc(100vh - 100px);
    }

    /* Products grid */
    .toolbar{display:flex; align-items:center; gap:10px; margin-bottom:12px}
    .search{
      flex:1; background:#0b1327; border:1px solid #223057; color:var(--ink);
      padding:10px 12px; border-radius:12px; outline:none;
    }
    .grid{
      display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px;
    }
    @media (max-width:1200px){ .grid{ grid-template-columns: repeat(3,1fr); } }
    @media (max-width:1000px){ .wrap{ grid-template-columns: 1fr; } .right{ position:relative; top:0 } }
    @media (max-width:800px){ .grid{ grid-template-columns: repeat(2,1fr); } }

    .card{
      background:linear-gradient(180deg,#1a243d,#1f2937);
      border:1px solid #263656; border-radius:16px; padding:16px; cursor:pointer;
      min-height:82px; display:flex; align-items:center; justify-content:center; text-align:center;
      font-weight:700; letter-spacing:.3px; box-shadow: var(--shadow);
      transition: transform .08s ease, border-color .2s ease;
    }
    .card:hover{ transform: translateY(-2px); border-color:#415a93; }
    .tag{font-size:12px; color:var(--muted); margin-top:6px}

    /* Order panel */
    .order-title{font-weight:800; font-size:20px; letter-spacing:.6px}
    .order-list{display:flex; flex-direction:column; gap:10px; overflow:auto; padding-right:2px}
    .line{
      display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:center;
      background:#0b1327; border:1px solid #223057; border-radius:12px; padding:10px 12px;
    }
    .line h4{margin:0; font-size:14px}
    .line .muted{color:var(--muted); font-size:12px}
    .qty{
      display:flex; align-items:center; gap:6px;
      background:#0b1225; border:1px solid #2a3554; border-radius:10px; padding:4px 6px;
    }
    .qty button{background:transparent; color:var(--ink); border:none; font-size:16px; cursor:pointer}
    .line .price{min-width:88px; text-align:right; font-variant-numeric: tabular-nums; font-weight:700}
    .remove{background:transparent; border:none; color:#fca5a5; cursor:pointer; margin-left:6px}
    .totals{margin-top:6px; border-top:1px dashed #334155; padding-top:10px; display:flex; justify-content:space-between; align-items:center}
    .total{font-size:18px; font-weight:900}

    .print-btn{margin-top:6px}

    /* Modal */
    .modal{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.5); z-index:60; padding:16px;
    }
    .modal.open{display:flex}
    .modal-card{
      width:min(520px, 96vw); background:var(--panel); border:1px solid #223057; border-radius:18px; padding:18px; box-shadow: var(--shadow);
      display:flex; flex-direction:column; gap:12px;
    }
    .modal .title{font-size:18px; font-weight:800}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    select, input[type="number"]{
      background:#0b1327; border:1px solid #223057; color:var(--ink);
      padding:8px 10px; border-radius:10px; outline:none;
    }

    /* Print styles */
    @media print{
      body{background:white}
      .topbar, .left, .btn, .toolbar{ display:none !important; }
      .right{
        position:static; box-shadow:none; border:none; padding:0; margin:0; width:100%;
      }
      .ticket{
        width: 72mm;  /* ancho típico de impresora térmica */
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
        color:#000; background:#fff;
      }
      .ticket h2{margin:0 0 6px 0}
      .line{border:none; background:#fff; padding:4px 0}
      .remove, .qty{display:none}
      .totals{border-top:1px solid #000}
      .print-note{display:block}
    }
    .print-note{display:none; color:#475569; font-size:12px}
    .small{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div>Pizza Gourmet Longchamps</div>
        <div class="small">Comandas · Pizzería & Empanadería</div>
      </div>
    </div>
    <div class="actions">
      <!-- Enlace directo a TU Google Sheet para editar precios -->
      <a class="btn btn-accent" id="editLink" href="#" target="_blank" rel="noopener">Editar precios</a>
      <button class="btn btn-ghost" id="reloadBtn" title="Recargar datos">&#x21bb; Recargar</button>
    </div>
  </header>

  <main class="wrap">
    <section class="left">
      <div class="toolbar">
        <input id="search" class="search" type="search" placeholder="Buscar producto…" />
        <span class="small" id="countBadge">0 productos</span>
      </div>
      <div id="grid" class="grid" aria-live="polite"></div>
      <div class="small" id="status"></div>
    </section>

    <aside class="right">
      <div class="order-title">Comanda</div>
      <div class="small">Click en un producto para añadirlo. Ajustá cantidades en la lista.</div>
      <div id="orderList" class="order-list"></div>
      <div class="totals">
        <span>Total</span>
        <span id="total" class="total">$ 0,00</span>
      </div>
      <div class="row">
        <button class="btn btn-danger" id="clearBtn">Vaciar</button>
        <button class="btn btn" id="printBtn">Imprimir</button>
      </div>
      <div class="print-note">— Fin de ticket —</div>
    </aside>
  </main>

  <!-- Modal de selección -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <div class="title" id="modalTitle">Añadir producto</div>
      <div class="row">
        <label for="sizeSel">Tamaño</label>
        <select id="sizeSel"></select>
      </div>
      <div class="row">
        <label for="qtyInp">Cantidad</label>
        <input id="qtyInp" type="number" min="1" value="1" />
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn" id="addBtn">Agregar</button>
        <button class="btn btn-ghost" id="cancelBtn">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // === CONFIG ===
    const SHEET_ID = "1vq34RVaka0N-5kX6BNXQzVrcjRKPvASZ1xJU4K6tg8M";
    // Si querés fijar una pestaña específica, poné el GID correspondiente:
    // Ej: const GID = "0"; y usá buildGVizUrl(true)
    const GID = null; // dejar en null para tomar la primera hoja
    const SHEET_EDIT_URL = "https://docs.google.com/spreadsheets/d/1vq34RVaka0N-5kX6BNXQzVrcjRKPvASZ1xJU4K6tg8M/edit?usp=sharing";

    // === STATE ===
    let rawRows = [];            // filas crudas de la hoja
    let products = [];           // productos agrupados [{producto, variantes:[{tamano, precio, categoria}]}]
    let cart = [];               // [{producto, tamano, cantidad, precio}]
    let currentPick = null;      // {producto, variantes}

    // === HELPERS ===
    const $ = sel => document.querySelector(sel);
    const nf = new Intl.NumberFormat('es-AR', { style:'currency', currency:'ARS', minimumFractionDigits:2 });

    function buildGVizUrl(useGid=false){
      if(useGid && GID){
        // Forzar una pestaña concreta
        return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${encodeURIComponent(GID)}&tqx=out:json`;
      }
      // Primera hoja por defecto
      return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
    }

    function setStatus(msg){ $("#status").textContent = msg || ""; }

    function normalizeKey(s){
      return String(s||"").trim().toLowerCase()
        .replace(/\s+/g," ")
        .replace(/[áàä]/g,"a").replace(/[éèë]/g,"e")
        .replace(/[íìï]/g,"i").replace(/[óòö]/g,"o")
        .replace(/[úùü]/g,"u").replace(/ñ/g,"n");
    }

    function mapRowToObj(row, colMap){
      // row.c -> array de celdas {v:valor}
      const c = row.c || [];
      return {
        categoria : String(c[colMap.categoria]?.v ?? "").trim(),
        producto  : String(c[colMap.producto]?.v ?? "").trim(),
        tamano    : String(c[colMap.tamano]?.v ?? "").trim(),
        precio    : Number(c[colMap.precio]?.v ?? c[colMap.precio]?.f ?? 0)
      };
    }

    function buildColMap(table){
      // Intenta mapear por labels; si no, usa índices 0..3
      const want = ["categoria","producto","tamano","tamaño","precio","tamano"]; // contemplar variantes
      const cols = (table.cols || []).map((col, idx) => {
        const key = normalizeKey(col.label || "");
        return { idx, key };
      });

      // Buscar matches por nombre
      const findIdx = (names) => {
        for(const name of names){
          const n = normalizeKey(name);
          const hit = cols.find(c => c.key === n);
          if(hit) return hit.idx;
        }
        return null;
      };

      let m = {
        categoria: findIdx(["categoria"]),
        producto : findIdx(["producto"]),
        tamano   : findIdx(["tamano","tamaño"]),
        precio   : findIdx(["precio"])
      };

      // Fallback si no encontró labels
      if([m.categoria,m.producto,m.tamano,m.precio].some(v => v == null)){
        m = { categoria:0, producto:1, tamano:2, precio:3 };
      }
      return m;
    }

    function groupProducts(rows){
      // Agrupar por nombre de producto
      const byName = new Map();
      for(const r of rows){
        if(!r.producto) continue;
        const key = r.producto.trim();
        if(!byName.has(key)) byName.set(key, []);
        byName.get(key).push({ tamano:r.tamano || "", precio:Number(r.precio)||0, categoria:r.categoria||"" });
      }
      const out = [];
      [...byName.entries()].forEach(([producto, variantes])=>{
        // Ordenar variantes por precio asc
        variantes.sort((a,b)=> (a.precio||0)-(b.precio||0));
        out.push({ producto, variantes });
      });
      // Orden alfabético
      out.sort((a,b)=> a.producto.localeCompare(b.producto,'es'));
      return out;
    }

    function renderGrid(list){
      const grid = $("#grid");
      grid.innerHTML = "";
      list.forEach(item=>{
        const div = document.createElement("button");
        div.className = "card";
        div.type = "button";
        div.setAttribute("aria-label", `Agregar ${item.producto}`);
        div.innerHTML = `<div>
          <div>${item.producto}</div>
          <div class="tag">${item.variantes.length ? (item.variantes[0].tamano || "—") : "—"}</div>
        </div>`;
        div.addEventListener("click", ()=> openModal(item));
        grid.appendChild(div);
      });
      $("#countBadge").textContent = `${list.length} producto${list.length===1?"":"s"}`;
    }

    function renderCart(){
      const list = $("#orderList");
      list.innerHTML = "";
      cart.forEach((it, idx)=>{
        const line = document.createElement("div");
        line.className = "line";

        const left = document.createElement("div");
        left.innerHTML = `<h4>${it.producto}</h4><div class="muted">${it.tamano || "—"}</div>`;

        const qty = document.createElement("div");
        qty.className = "qty";
        const minus = document.createElement("button"); minus.textContent = "−";
        const span  = document.createElement("span"); span.textContent = it.cantidad;
        const plus  = document.createElement("button"); plus.textContent = "+";
        minus.addEventListener("click", ()=> changeQty(idx, -1));
        plus.addEventListener("click", ()=> changeQty(idx, +1));
        qty.append(minus, span, plus);

        const price = document.createElement("div");
        price.className = "price";
        price.textContent = nf.format(it.cantidad * it.precio);

        const rm = document.createElement("button");
        rm.className = "remove";
        rm.title = "Quitar";
        rm.textContent = "✕";
        rm.addEventListener("click", ()=> removeLine(idx));

        line.append(left, qty, price, rm);
        list.appendChild(line);
      });

      const total = cart.reduce((acc, it)=> acc + it.cantidad*it.precio, 0);
      $("#total").textContent = nf.format(total);
    }

    function changeQty(idx, delta){
      cart[idx].cantidad += delta;
      if(cart[idx].cantidad <= 0){ cart.splice(idx,1); }
      renderCart();
      persistCart();
    }
    function removeLine(idx){
      cart.splice(idx,1);
      renderCart();
      persistCart();
    }

    function addToCart(producto, tamano, precio, cantidad){
      // Si ya existe misma línea (producto+tamano+precio), sumar cantidad
      const i = cart.findIndex(it=> it.producto===producto && it.tamano===tamano && it.precio===precio);
      if(i>=0){ cart[i].cantidad += cantidad; }
      else { cart.push({ producto, tamano, precio, cantidad }); }
      renderCart();
      persistCart();
    }

    // === MODAL ===
    function openModal(item){
      currentPick = item;
      $("#modalTitle").textContent = item.producto;
      const sel = $("#sizeSel");
      sel.innerHTML = "";
      (item.variantes.length ? item.variantes : [{tamano:"Único", precio: item.variantes?.[0]?.precio || 0}])
        .forEach(v=>{
          const opt = document.createElement("option");
          const labelTam = v.tamano || "Único";
          opt.value = JSON.stringify({tamano:labelTam, precio:Number(v.precio)||0});
          opt.textContent = `${labelTam} — ${nf.format(Number(v.precio)||0)}`;
          sel.appendChild(opt);
        });
      $("#qtyInp").value = 1;
      $("#modal").classList.add("open");
    }
    function closeModal(){ $("#modal").classList.remove("open"); currentPick=null; }

    $("#addBtn").addEventListener("click", ()=>{
      try{
        const { tamano, precio } = JSON.parse($("#sizeSel").value || "{}");
        const qty = Math.max(1, parseInt($("#qtyInp").value||"1",10));
        if(!currentPick) return;
        addToCart(currentPick.producto, tamano, Number(precio)||0, qty);
      }catch(e){}
      closeModal();
    });
    $("#cancelBtn").addEventListener("click", closeModal);
    $("#modal").addEventListener("click", (e)=>{ if(e.target===e.currentTarget) closeModal(); });
    window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });

    // === STORAGE ===
    function persistCart(){ localStorage.setItem("pgl_cart", JSON.stringify(cart)); }
    function restoreCart(){
      try{
        const raw = localStorage.getItem("pgl_cart");
        cart = raw ? JSON.parse(raw) : [];
      }catch{ cart = []; }
      renderCart();
    }

    // === FETCH ===
    async function fetchSheet(){
      setStatus("Cargando productos…");
      try{
        const url = buildGVizUrl(Boolean(GID));
        const res = await fetch(url);
        if(!res.ok) throw new Error("No se pudo leer la hoja (revisá permisos).");
        const text = await res.text();

        // gviz devuelve algo como: google.visualization.Query.setResponse({...});
        const jsonStr = text.replace(/^[\s\S]*setResponse\(/, "").replace(/\);?\s*$/, "");
        const data = JSON.parse(jsonStr);
        const table = data.table;
        const colMap = buildColMap(table);
        const rows = (table.rows || [])
          .map(r=> mapRowToObj(r, colMap))
          // Filtrar filas vacías
          .filter(r=> r.producto);

        rawRows = rows;
        products = groupProducts(rows);
        renderGrid(products);
        setStatus(products.length ? "" : "No se encontraron productos.");
      }catch(err){
        console.error(err);
        setStatus("Error al cargar datos. Verificá que el archivo esté compartido como 'Cualquiera con el enlace (lector)'.");
      }
    }

    // === SEARCH ===
    $("#search").addEventListener("input", (e)=>{
      const q = normalizeKey(e.target.value);
      const filtered = !q ? products :
        products.filter(p=> normalizeKey(p.producto).includes(q));
      renderGrid(filtered);
    });

    // === TOP ACTIONS ===
    $("#editLink").href = SHEET_EDIT_URL;
    $("#reloadBtn").addEventListener("click", fetchSheet);

    // === ORDER ACTIONS ===
    $("#clearBtn").addEventListener("click", ()=>{
      if(confirm("¿Vaciar comanda?")){ cart = []; renderCart(); persistCart(); }
    });

    // === PRINT ===
    $("#printBtn").addEventListener("click", ()=>{
      // Antes de imprimir, forzamos estilos de ticket dentro del panel derecho
      document.querySelector(".right").classList.add("ticket");
      window.print();
      setTimeout(()=> document.querySelector(".right").classList.remove("ticket"), 0);
    });

    // === INIT ===
    restoreCart();
    fetchSheet();
  })();
  </script>
</body>
</html>
